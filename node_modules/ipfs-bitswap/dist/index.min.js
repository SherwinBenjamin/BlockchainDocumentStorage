(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.IpfsBitswap = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var IpfsBitswap=(()=>{var bi=Object.create;var We=Object.defineProperty;var _i=Object.getOwnPropertyDescriptor;var vi=Object.getOwnPropertyNames;var xi=Object.getPrototypeOf,ki=Object.prototype.hasOwnProperty;var _=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),P=(r,e)=>{for(var t in e)We(r,t,{get:e[t],enumerable:!0})},Fr=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of vi(e))!ki.call(r,s)&&s!==t&&We(r,s,{get:()=>e[s],enumerable:!(n=_i(e,s))||n.enumerable});return r};var M=(r,e,t)=>(t=r!=null?bi(xi(r)):{},Fr(e||!r||!r.__esModule?We(t,"default",{value:r,enumerable:!0}):t,r)),Ei=r=>Fr(We({},"__esModule",{value:!0}),r);var Yr=_((Gc,Zr)=>{Zr.exports=Kr;var Jr=128,fo=127,po=~fo,go=Math.pow(2,31);function Kr(r,e,t){e=e||[],t=t||0;for(var n=t;r>=go;)e[t++]=r&255|Jr,r/=128;for(;r&po;)e[t++]=r&255|Jr,r>>>=7;return e[t]=r|0,Kr.bytes=t-n+1,e}});var rn=_((jc,tn)=>{tn.exports=Ot;var mo=128,en=127;function Ot(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Ot.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&en)<<s:(o&en)*Math.pow(2,s),s+=7}while(o>=mo);return Ot.bytes=i-n,t}});var sn=_((Qc,nn)=>{var yo=Math.pow(2,7),wo=Math.pow(2,14),bo=Math.pow(2,21),_o=Math.pow(2,28),vo=Math.pow(2,35),xo=Math.pow(2,42),ko=Math.pow(2,49),Eo=Math.pow(2,56),So=Math.pow(2,63);nn.exports=function(r){return r<yo?1:r<wo?2:r<bo?3:r<_o?4:r<vo?5:r<xo?6:r<ko?7:r<Eo?8:r<So?9:10}});var an=_((Xc,on)=>{on.exports={encode:Yr(),decode:rn(),encodingLength:sn()}});var ln=_((Jc,un)=>{"use strict";var cn=an();un.exports=r=>{if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");let e=[];for(;r.length>0;){let t=cn.decode(r);e.push(t),r=r.slice(cn.decode.bytes)}return e}});var fn=_((Kc,hn)=>{var xe=1e3,ke=xe*60,Ee=ke*60,oe=Ee*24,Co=oe*7,Ao=oe*365.25;hn.exports=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return Lo(r);if(t==="number"&&isFinite(r))return e.long?Bo(r):To(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function Lo(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(e){var t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*Ao;case"weeks":case"week":case"w":return t*Co;case"days":case"day":case"d":return t*oe;case"hours":case"hour":case"hrs":case"hr":case"h":return t*Ee;case"minutes":case"minute":case"mins":case"min":case"m":return t*ke;case"seconds":case"second":case"secs":case"sec":case"s":return t*xe;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function To(r){var e=Math.abs(r);return e>=oe?Math.round(r/oe)+"d":e>=Ee?Math.round(r/Ee)+"h":e>=ke?Math.round(r/ke)+"m":e>=xe?Math.round(r/xe)+"s":r+"ms"}function Bo(r){var e=Math.abs(r);return e>=oe?Ge(r,e,oe,"day"):e>=Ee?Ge(r,e,Ee,"hour"):e>=ke?Ge(r,e,ke,"minute"):e>=xe?Ge(r,e,xe,"second"):r+" ms"}function Ge(r,e,t,n){var s=e>=t*1.5;return Math.round(r/t)+" "+n+(s?"s":"")}});var pn=_((Zc,dn)=>{function Fo(r){t.debug=t,t.default=t,t.coerce=c,t.disable=i,t.enable=s,t.enabled=o,t.humanize=fn(),t.destroy=u,Object.keys(r).forEach(l=>{t[l]=r[l]}),t.names=[],t.skips=[],t.formatters={};function e(l){let h=0;for(let f=0;f<l.length;f++)h=(h<<5)-h+l.charCodeAt(f),h|=0;return t.colors[Math.abs(h)%t.colors.length]}t.selectColor=e;function t(l){let h,f=null,y,d;function m(...p){if(!m.enabled)return;let x=m,E=Number(new Date),A=E-(h||E);x.diff=A,x.prev=h,x.curr=E,h=E,p[0]=t.coerce(p[0]),typeof p[0]!="string"&&p.unshift("%O");let L=0;p[0]=p[0].replace(/%([a-zA-Z%])/g,(z,I)=>{if(z==="%%")return"%";L++;let q=t.formatters[I];if(typeof q=="function"){let me=p[L];z=q.call(x,me),p.splice(L,1),L--}return z}),t.formatArgs.call(x,p),(x.log||t.log).apply(x,p)}return m.namespace=l,m.useColors=t.useColors(),m.color=t.selectColor(l),m.extend=n,m.destroy=t.destroy,Object.defineProperty(m,"enabled",{enumerable:!0,configurable:!1,get:()=>f!==null?f:(y!==t.namespaces&&(y=t.namespaces,d=t.enabled(l)),d),set:p=>{f=p}}),typeof t.init=="function"&&t.init(m),m}function n(l,h){let f=t(this.namespace+(typeof h>"u"?":":h)+l);return f.log=this.log,f}function s(l){t.save(l),t.namespaces=l,t.names=[],t.skips=[];let h,f=(typeof l=="string"?l:"").split(/[\s,]+/),y=f.length;for(h=0;h<y;h++)f[h]&&(l=f[h].replace(/\*/g,".*?"),l[0]==="-"?t.skips.push(new RegExp("^"+l.slice(1)+"$")):t.names.push(new RegExp("^"+l+"$")))}function i(){let l=[...t.names.map(a),...t.skips.map(a).map(h=>"-"+h)].join(",");return t.enable(""),l}function o(l){if(l[l.length-1]==="*")return!0;let h,f;for(h=0,f=t.skips.length;h<f;h++)if(t.skips[h].test(l))return!1;for(h=0,f=t.names.length;h<f;h++)if(t.names[h].test(l))return!0;return!1}function a(l){return l.toString().substring(2,l.toString().length-2).replace(/\.\*\?$/,"*")}function c(l){return l instanceof Error?l.stack||l.message:l}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}dn.exports=Fo});var gn=_((R,je)=>{R.formatArgs=Mo;R.save=No;R.load=Oo;R.useColors=Do;R.storage=Io();R.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();R.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function Do(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function Mo(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+je.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(n=t))}),r.splice(n,0,e)}R.log=console.debug||console.log||(()=>{});function No(r){try{r?R.storage.setItem("debug",r):R.storage.removeItem("debug")}catch{}}function Oo(){let r;try{r=R.storage.getItem("debug")}catch{}return!r&&typeof process<"u"&&"env"in process&&(r=process.env.DEBUG),r}function Io(){try{return localStorage}catch{}}je.exports=pn()(R);var{formatters:Po}=je.exports;Po.j=function(r){try{return JSON.stringify(r)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var bn=_((pu,wn)=>{wn.exports=Rt;var yn=128,Ho=127,Wo=~Ho,Vo=Math.pow(2,31);function Rt(r,e,t){if(Number.MAX_SAFE_INTEGER&&r>Number.MAX_SAFE_INTEGER)throw Rt.bytes=0,new RangeError("Could not encode varint");e=e||[],t=t||0;for(var n=t;r>=Vo;)e[t++]=r&255|yn,r/=128;for(;r&Wo;)e[t++]=r&255|yn,r>>>=7;return e[t]=r|0,Rt.bytes=t-n+1,e}});var xn=_((gu,vn)=>{vn.exports=Ut;var $o=128,_n=127;function Ut(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a||s>49)throw Ut.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&_n)<<s:(o&_n)*Math.pow(2,s),s+=7}while(o>=$o);return Ut.bytes=i-n,t}});var En=_((mu,kn)=>{var Go=Math.pow(2,7),jo=Math.pow(2,14),Qo=Math.pow(2,21),Xo=Math.pow(2,28),Jo=Math.pow(2,35),Ko=Math.pow(2,42),Zo=Math.pow(2,49),Yo=Math.pow(2,56),ea=Math.pow(2,63);kn.exports=function(r){return r<Go?1:r<jo?2:r<Qo?3:r<Xo?4:r<Jo?5:r<Ko?6:r<Zo?7:r<Yo?8:r<ea?9:10}});var Cn=_((yu,Sn)=>{Sn.exports={encode:bn(),decode:xn(),encodingLength:En()}});var Tn=_((bu,Ln)=>{"use strict";Ln.exports=ra;function ra(r,e){for(var t=new Array(arguments.length-1),n=0,s=2,i=!0;s<arguments.length;)t[n++]=arguments[s++];return new Promise(function(a,c){t[n]=function(l){if(i)if(i=!1,l)c(l);else{for(var h=new Array(arguments.length-1),f=0;f<h.length;)h[f++]=arguments[f];a.apply(null,h)}};try{r.apply(e||null,t)}catch(u){i&&(i=!1,c(u))}})}});var Mn=_(Dn=>{"use strict";var Je=Dn;Je.length=function(e){var t=e.length;if(!t)return 0;for(var n=0;--t%4>1&&e.charAt(t)==="=";)++n;return Math.ceil(e.length*3)/4-n};var Se=new Array(64),Fn=new Array(123);for(V=0;V<64;)Fn[Se[V]=V<26?V+65:V<52?V+71:V<62?V-4:V-59|43]=V++;var V;Je.encode=function(e,t,n){for(var s=null,i=[],o=0,a=0,c;t<n;){var u=e[t++];switch(a){case 0:i[o++]=Se[u>>2],c=(u&3)<<4,a=1;break;case 1:i[o++]=Se[c|u>>4],c=(u&15)<<2,a=2;break;case 2:i[o++]=Se[c|u>>6],i[o++]=Se[u&63],a=0;break}o>8191&&((s||(s=[])).push(String.fromCharCode.apply(String,i)),o=0)}return a&&(i[o++]=Se[c],i[o++]=61,a===1&&(i[o++]=61)),s?(o&&s.push(String.fromCharCode.apply(String,i.slice(0,o))),s.join("")):String.fromCharCode.apply(String,i.slice(0,o))};var Bn="invalid encoding";Je.decode=function(e,t,n){for(var s=n,i=0,o,a=0;a<e.length;){var c=e.charCodeAt(a++);if(c===61&&i>1)break;if((c=Fn[c])===void 0)throw Error(Bn);switch(i){case 0:o=c,i=1;break;case 1:t[n++]=o<<2|(c&48)>>4,o=c,i=2;break;case 2:t[n++]=(o&15)<<4|(c&60)>>2,o=c,i=3;break;case 3:t[n++]=(o&3)<<6|c,i=0;break}}if(i===1)throw Error(Bn);return n-s};Je.test=function(e){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e)}});var On=_((vu,Nn)=>{"use strict";Nn.exports=Ke;function Ke(){this._listeners={}}Ke.prototype.on=function(e,t,n){return(this._listeners[e]||(this._listeners[e]=[])).push({fn:t,ctx:n||this}),this};Ke.prototype.off=function(e,t){if(e===void 0)this._listeners={};else if(t===void 0)this._listeners[e]=[];else for(var n=this._listeners[e],s=0;s<n.length;)n[s].fn===t?n.splice(s,1):++s;return this};Ke.prototype.emit=function(e){var t=this._listeners[e];if(t){for(var n=[],s=1;s<arguments.length;)n.push(arguments[s++]);for(s=0;s<t.length;)t[s].fn.apply(t[s++].ctx,n)}return this}});var Hn=_((xu,qn)=>{"use strict";qn.exports=In(In);function In(r){return typeof Float32Array<"u"?function(){var e=new Float32Array([-0]),t=new Uint8Array(e.buffer),n=t[3]===128;function s(c,u,l){e[0]=c,u[l]=t[0],u[l+1]=t[1],u[l+2]=t[2],u[l+3]=t[3]}function i(c,u,l){e[0]=c,u[l]=t[3],u[l+1]=t[2],u[l+2]=t[1],u[l+3]=t[0]}r.writeFloatLE=n?s:i,r.writeFloatBE=n?i:s;function o(c,u){return t[0]=c[u],t[1]=c[u+1],t[2]=c[u+2],t[3]=c[u+3],e[0]}function a(c,u){return t[3]=c[u],t[2]=c[u+1],t[1]=c[u+2],t[0]=c[u+3],e[0]}r.readFloatLE=n?o:a,r.readFloatBE=n?a:o}():function(){function e(n,s,i,o){var a=s<0?1:0;if(a&&(s=-s),s===0)n(1/s>0?0:2147483648,i,o);else if(isNaN(s))n(2143289344,i,o);else if(s>34028234663852886e22)n((a<<31|2139095040)>>>0,i,o);else if(s<11754943508222875e-54)n((a<<31|Math.round(s/1401298464324817e-60))>>>0,i,o);else{var c=Math.floor(Math.log(s)/Math.LN2),u=Math.round(s*Math.pow(2,-c)*8388608)&8388607;n((a<<31|c+127<<23|u)>>>0,i,o)}}r.writeFloatLE=e.bind(null,Pn),r.writeFloatBE=e.bind(null,Rn);function t(n,s,i){var o=n(s,i),a=(o>>31)*2+1,c=o>>>23&255,u=o&8388607;return c===255?u?NaN:a*(1/0):c===0?a*1401298464324817e-60*u:a*Math.pow(2,c-150)*(u+8388608)}r.readFloatLE=t.bind(null,Un),r.readFloatBE=t.bind(null,zn)}(),typeof Float64Array<"u"?function(){var e=new Float64Array([-0]),t=new Uint8Array(e.buffer),n=t[7]===128;function s(c,u,l){e[0]=c,u[l]=t[0],u[l+1]=t[1],u[l+2]=t[2],u[l+3]=t[3],u[l+4]=t[4],u[l+5]=t[5],u[l+6]=t[6],u[l+7]=t[7]}function i(c,u,l){e[0]=c,u[l]=t[7],u[l+1]=t[6],u[l+2]=t[5],u[l+3]=t[4],u[l+4]=t[3],u[l+5]=t[2],u[l+6]=t[1],u[l+7]=t[0]}r.writeDoubleLE=n?s:i,r.writeDoubleBE=n?i:s;function o(c,u){return t[0]=c[u],t[1]=c[u+1],t[2]=c[u+2],t[3]=c[u+3],t[4]=c[u+4],t[5]=c[u+5],t[6]=c[u+6],t[7]=c[u+7],e[0]}function a(c,u){return t[7]=c[u],t[6]=c[u+1],t[5]=c[u+2],t[4]=c[u+3],t[3]=c[u+4],t[2]=c[u+5],t[1]=c[u+6],t[0]=c[u+7],e[0]}r.readDoubleLE=n?o:a,r.readDoubleBE=n?a:o}():function(){function e(n,s,i,o,a,c){var u=o<0?1:0;if(u&&(o=-o),o===0)n(0,a,c+s),n(1/o>0?0:2147483648,a,c+i);else if(isNaN(o))n(0,a,c+s),n(2146959360,a,c+i);else if(o>17976931348623157e292)n(0,a,c+s),n((u<<31|2146435072)>>>0,a,c+i);else{var l;if(o<22250738585072014e-324)l=o/5e-324,n(l>>>0,a,c+s),n((u<<31|l/4294967296)>>>0,a,c+i);else{var h=Math.floor(Math.log(o)/Math.LN2);h===1024&&(h=1023),l=o*Math.pow(2,-h),n(l*4503599627370496>>>0,a,c+s),n((u<<31|h+1023<<20|l*1048576&1048575)>>>0,a,c+i)}}}r.writeDoubleLE=e.bind(null,Pn,0,4),r.writeDoubleBE=e.bind(null,Rn,4,0);function t(n,s,i,o,a){var c=n(o,a+s),u=n(o,a+i),l=(u>>31)*2+1,h=u>>>20&2047,f=4294967296*(u&1048575)+c;return h===2047?f?NaN:l*(1/0):h===0?l*5e-324*f:l*Math.pow(2,h-1075)*(f+4503599627370496)}r.readDoubleLE=t.bind(null,Un,0,4),r.readDoubleBE=t.bind(null,zn,4,0)}(),r}function Pn(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function Rn(r,e,t){e[t]=r>>>24,e[t+1]=r>>>16&255,e[t+2]=r>>>8&255,e[t+3]=r&255}function Un(r,e){return(r[e]|r[e+1]<<8|r[e+2]<<16|r[e+3]<<24)>>>0}function zn(r,e){return(r[e]<<24|r[e+1]<<16|r[e+2]<<8|r[e+3])>>>0}});var Wn=_((exports,module)=>{"use strict";module.exports=inquire;function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(r){}return null}});var $n=_(Vn=>{"use strict";var zt=Vn;zt.length=function(e){for(var t=0,n=0,s=0;s<e.length;++s)n=e.charCodeAt(s),n<128?t+=1:n<2048?t+=2:(n&64512)===55296&&(e.charCodeAt(s+1)&64512)===56320?(++s,t+=4):t+=3;return t};zt.read=function(e,t,n){var s=n-t;if(s<1)return"";for(var i=null,o=[],a=0,c;t<n;)c=e[t++],c<128?o[a++]=c:c>191&&c<224?o[a++]=(c&31)<<6|e[t++]&63:c>239&&c<365?(c=((c&7)<<18|(e[t++]&63)<<12|(e[t++]&63)<<6|e[t++]&63)-65536,o[a++]=55296+(c>>10),o[a++]=56320+(c&1023)):o[a++]=(c&15)<<12|(e[t++]&63)<<6|e[t++]&63,a>8191&&((i||(i=[])).push(String.fromCharCode.apply(String,o)),a=0);return i?(a&&i.push(String.fromCharCode.apply(String,o.slice(0,a))),i.join("")):String.fromCharCode.apply(String,o.slice(0,a))};zt.write=function(e,t,n){for(var s=n,i,o,a=0;a<e.length;++a)i=e.charCodeAt(a),i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=i&63|128):(i&64512)===55296&&((o=e.charCodeAt(a+1))&64512)===56320?(i=65536+((i&1023)<<10)+(o&1023),++a,t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=i&63|128):(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=i&63|128);return n-s}});var jn=_((Eu,Gn)=>{"use strict";Gn.exports=na;function na(r,e,t){var n=t||8192,s=n>>>1,i=null,o=n;return function(c){if(c<1||c>s)return r(c);o+c>n&&(i=r(n),o=0);var u=e.call(i,o,o+=c);return o&7&&(o=(o|7)+1),u}}});var Xn=_((Su,Qn)=>{"use strict";Qn.exports=T;var Pe=ue();function T(r,e){this.lo=r>>>0,this.hi=e>>>0}var ce=T.zero=new T(0,0);ce.toNumber=function(){return 0};ce.zzEncode=ce.zzDecode=function(){return this};ce.length=function(){return 1};var sa=T.zeroHash="\0\0\0\0\0\0\0\0";T.fromNumber=function(e){if(e===0)return ce;var t=e<0;t&&(e=-e);var n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new T(n,s)};T.from=function(e){if(typeof e=="number")return T.fromNumber(e);if(Pe.isString(e))if(Pe.Long)e=Pe.Long.fromString(e);else return T.fromNumber(parseInt(e,10));return e.low||e.high?new T(e.low>>>0,e.high>>>0):ce};T.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=~this.lo+1>>>0,n=~this.hi>>>0;return t||(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296};T.prototype.toLong=function(e){return Pe.Long?new Pe.Long(this.lo|0,this.hi|0,!!e):{low:this.lo|0,high:this.hi|0,unsigned:!!e}};var re=String.prototype.charCodeAt;T.fromHash=function(e){return e===sa?ce:new T((re.call(e,0)|re.call(e,1)<<8|re.call(e,2)<<16|re.call(e,3)<<24)>>>0,(re.call(e,4)|re.call(e,5)<<8|re.call(e,6)<<16|re.call(e,7)<<24)>>>0)};T.prototype.toHash=function(){return String.fromCharCode(this.lo&255,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,this.hi&255,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)};T.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this};T.prototype.zzDecode=function(){var e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this};T.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}});var ue=_(qt=>{"use strict";var g=qt;g.asPromise=Tn();g.base64=Mn();g.EventEmitter=On();g.float=Hn();g.inquire=Wn();g.utf8=$n();g.pool=jn();g.LongBits=Xn();g.isNode=!!(typeof globalThis<"u"&&globalThis&&globalThis.process&&globalThis.process.versions&&globalThis.process.versions.node);g.global=g.isNode&&globalThis||typeof window<"u"&&window||typeof self<"u"&&self||qt;g.emptyArray=Object.freeze?Object.freeze([]):[];g.emptyObject=Object.freeze?Object.freeze({}):{};g.isInteger=Number.isInteger||function(e){return typeof e=="number"&&isFinite(e)&&Math.floor(e)===e};g.isString=function(e){return typeof e=="string"||e instanceof String};g.isObject=function(e){return e&&typeof e=="object"};g.isset=g.isSet=function(e,t){var n=e[t];return n!=null&&e.hasOwnProperty(t)?typeof n!="object"||(Array.isArray(n)?n.length:Object.keys(n).length)>0:!1};g.Buffer=function(){try{var r=g.inquire("buffer").Buffer;return r.prototype.utf8Write?r:null}catch{return null}}();g._Buffer_from=null;g._Buffer_allocUnsafe=null;g.newBuffer=function(e){return typeof e=="number"?g.Buffer?g._Buffer_allocUnsafe(e):new g.Array(e):g.Buffer?g._Buffer_from(e):typeof Uint8Array>"u"?e:new Uint8Array(e)};g.Array=typeof Uint8Array<"u"?Uint8Array:Array;g.Long=g.global.dcodeIO&&g.global.dcodeIO.Long||g.global.Long||g.inquire("long");g.key2Re=/^true|false|0|1$/;g.key32Re=/^-?(?:0|[1-9][0-9]*)$/;g.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/;g.longToHash=function(e){return e?g.LongBits.from(e).toHash():g.LongBits.zeroHash};g.longFromHash=function(e,t){var n=g.LongBits.fromHash(e);return g.Long?g.Long.fromBits(n.lo,n.hi,t):n.toNumber(!!t)};function Jn(r,e,t){for(var n=Object.keys(e),s=0;s<n.length;++s)(r[n[s]]===void 0||!t)&&(r[n[s]]=e[n[s]]);return r}g.merge=Jn;g.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)};function Kn(r){function e(t,n){if(!(this instanceof e))return new e(t,n);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:new Error().stack||""}),n&&Jn(this,n)}return e.prototype=Object.create(Error.prototype,{constructor:{value:e,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return r},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),e}g.newError=Kn;g.ProtocolError=Kn("ProtocolError");g.oneOfGetter=function(e){for(var t={},n=0;n<e.length;++n)t[e[n]]=1;return function(){for(var s=Object.keys(this),i=s.length-1;i>-1;--i)if(t[s[i]]===1&&this[s[i]]!==void 0&&this[s[i]]!==null)return s[i]}};g.oneOfSetter=function(e){return function(t){for(var n=0;n<e.length;++n)e[n]!==t&&delete this[e[n]]}};g.toJSONOptions={longs:String,enums:String,bytes:String,json:!0};g._configure=function(){var r=g.Buffer;if(!r){g._Buffer_from=g._Buffer_allocUnsafe=null;return}g._Buffer_from=r.from!==Uint8Array.from&&r.from||function(t,n){return new r(t,n)},g._Buffer_allocUnsafe=r.allocUnsafe||function(t){return new r(t)}}});var Vt=_((Au,rs)=>{"use strict";rs.exports=C;var $=ue(),Wt,es=$.LongBits,ia=$.utf8;function G(r,e){return RangeError("index out of range: "+r.pos+" + "+(e||1)+" > "+r.len)}function C(r){this.buf=r,this.pos=0,this.len=r.length}var Zn=typeof Uint8Array<"u"?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new C(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new C(e);throw Error("illegal buffer")},ts=function(){return $.Buffer?function(t){return(C.create=function(s){return $.Buffer.isBuffer(s)?new Wt(s):Zn(s)})(t)}:Zn};C.create=ts();C.prototype._slice=$.Array.prototype.subarray||$.Array.prototype.slice;C.prototype.uint32=function(){var e=4294967295;return function(){if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,G(this,10);return e}}();C.prototype.int32=function(){return this.uint32()|0};C.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(e&1)|0};function Ht(){var r=new es(0,0),e=0;if(this.len-this.pos>4){for(;e<4;++e)if(r.lo=(r.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return r;if(r.lo=(r.lo|(this.buf[this.pos]&127)<<28)>>>0,r.hi=(r.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return r;e=0}else{for(;e<3;++e){if(this.pos>=this.len)throw G(this);if(r.lo=(r.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return r}return r.lo=(r.lo|(this.buf[this.pos++]&127)<<e*7)>>>0,r}if(this.len-this.pos>4){for(;e<5;++e)if(r.hi=(r.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return r}else for(;e<5;++e){if(this.pos>=this.len)throw G(this);if(r.hi=(r.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return r}throw Error("invalid varint encoding")}C.prototype.bool=function(){return this.uint32()!==0};function Ze(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}C.prototype.fixed32=function(){if(this.pos+4>this.len)throw G(this,4);return Ze(this.buf,this.pos+=4)};C.prototype.sfixed32=function(){if(this.pos+4>this.len)throw G(this,4);return Ze(this.buf,this.pos+=4)|0};function Yn(){if(this.pos+8>this.len)throw G(this,8);return new es(Ze(this.buf,this.pos+=4),Ze(this.buf,this.pos+=4))}C.prototype.float=function(){if(this.pos+4>this.len)throw G(this,4);var e=$.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e};C.prototype.double=function(){if(this.pos+8>this.len)throw G(this,4);var e=$.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e};C.prototype.bytes=function(){var e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw G(this,e);if(this.pos+=e,Array.isArray(this.buf))return this.buf.slice(t,n);if(t===n){var s=$.Buffer;return s?s.alloc(0):new this.buf.constructor(0)}return this._slice.call(this.buf,t,n)};C.prototype.string=function(){var e=this.bytes();return ia.read(e,0,e.length)};C.prototype.skip=function(e){if(typeof e=="number"){if(this.pos+e>this.len)throw G(this,e);this.pos+=e}else do if(this.pos>=this.len)throw G(this);while(this.buf[this.pos++]&128);return this};C.prototype.skipType=function(r){switch(r){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(r=this.uint32()&7)!==4;)this.skipType(r);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+r+" at offset "+this.pos)}return this};C._configure=function(r){Wt=r,C.create=ts(),Wt._configure();var e=$.Long?"toLong":"toNumber";$.merge(C.prototype,{int64:function(){return Ht.call(this)[e](!1)},uint64:function(){return Ht.call(this)[e](!0)},sint64:function(){return Ht.call(this).zzDecode()[e](!1)},fixed64:function(){return Yn.call(this)[e](!0)},sfixed64:function(){return Yn.call(this)[e](!1)}})}});var os=_((Lu,is)=>{"use strict";is.exports=le;var ss=Vt();(le.prototype=Object.create(ss.prototype)).constructor=le;var ns=ue();function le(r){ss.call(this,r)}le._configure=function(){ns.Buffer&&(le.prototype._slice=ns.Buffer.prototype.slice)};le.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+e,this.len))};le._configure()});var Kt=_((Tu,ls)=>{"use strict";ls.exports=b;var W=ue(),$t,Ye=W.LongBits,as=W.base64,cs=W.utf8;function Re(r,e,t){this.fn=r,this.len=e,this.next=void 0,this.val=t}function jt(){}function oa(r){this.head=r.head,this.tail=r.tail,this.len=r.len,this.next=r.states}function b(){this.len=0,this.head=new Re(jt,0,0),this.tail=this.head,this.states=null}var us=function(){return W.Buffer?function(){return(b.create=function(){return new $t})()}:function(){return new b}};b.create=us();b.alloc=function(e){return new W.Array(e)};W.Array!==Array&&(b.alloc=W.pool(b.alloc,W.Array.prototype.subarray));b.prototype._push=function(e,t,n){return this.tail=this.tail.next=new Re(e,t,n),this.len+=t,this};function Qt(r,e,t){e[t]=r&255}function aa(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}function Xt(r,e){this.len=r,this.next=void 0,this.val=e}Xt.prototype=Object.create(Re.prototype);Xt.prototype.fn=aa;b.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new Xt((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this};b.prototype.int32=function(e){return e<0?this._push(Jt,10,Ye.fromNumber(e)):this.uint32(e)};b.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)};function Jt(r,e,t){for(;r.hi;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}b.prototype.uint64=function(e){var t=Ye.from(e);return this._push(Jt,t.length(),t)};b.prototype.int64=b.prototype.uint64;b.prototype.sint64=function(e){var t=Ye.from(e).zzEncode();return this._push(Jt,t.length(),t)};b.prototype.bool=function(e){return this._push(Qt,1,e?1:0)};function Gt(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}b.prototype.fixed32=function(e){return this._push(Gt,4,e>>>0)};b.prototype.sfixed32=b.prototype.fixed32;b.prototype.fixed64=function(e){var t=Ye.from(e);return this._push(Gt,4,t.lo)._push(Gt,4,t.hi)};b.prototype.sfixed64=b.prototype.fixed64;b.prototype.float=function(e){return this._push(W.float.writeFloatLE,4,e)};b.prototype.double=function(e){return this._push(W.float.writeDoubleLE,8,e)};var ca=W.Array.prototype.set?function(e,t,n){t.set(e,n)}:function(e,t,n){for(var s=0;s<e.length;++s)t[n+s]=e[s]};b.prototype.bytes=function(e){var t=e.length>>>0;if(!t)return this._push(Qt,1,0);if(W.isString(e)){var n=b.alloc(t=as.length(e));as.decode(e,n,0),e=n}return this.uint32(t)._push(ca,t,e)};b.prototype.string=function(e){var t=cs.length(e);return t?this.uint32(t)._push(cs.write,t,e):this._push(Qt,1,0)};b.prototype.fork=function(){return this.states=new oa(this),this.head=this.tail=new Re(jt,0,0),this.len=0,this};b.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Re(jt,0,0),this.len=0),this};b.prototype.ldelim=function(){var e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=e.next,this.tail=t,this.len+=n),this};b.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),n=0;e;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t};b._configure=function(r){$t=r,b.create=us(),$t._configure()}});var ds=_((Bu,fs)=>{"use strict";fs.exports=X;var hs=Kt();(X.prototype=Object.create(hs.prototype)).constructor=X;var ne=ue();function X(){hs.call(this)}X._configure=function(){X.alloc=ne._Buffer_allocUnsafe,X.writeBytesBuffer=ne.Buffer&&ne.Buffer.prototype instanceof Uint8Array&&ne.Buffer.prototype.set.name==="set"?function(e,t,n){t.set(e,n)}:function(e,t,n){if(e.copy)e.copy(t,n,0,e.length);else for(var s=0;s<e.length;)t[n++]=e[s++]}};X.prototype.bytes=function(e){ne.isString(e)&&(e=ne._Buffer_from(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this._push(X.writeBytesBuffer,t,e),this};function ua(r,e,t){r.length<40?ne.utf8.write(r,e,t):e.utf8Write?e.utf8Write(r,t):e.write(r,t)}X.prototype.string=function(e){var t=ne.Buffer.byteLength(e);return this.uint32(t),t&&this._push(ua,t,e),this};X._configure()});var Bs=_((Hl,Ts)=>{"use strict";function Ls(r,e){for(let t in e)Object.defineProperty(r,t,{value:e[t],enumerable:!0,configurable:!0});return r}function Ca(r,e,t){if(!r||typeof r=="string")throw new TypeError("Please pass an Error to err-code");t||(t={}),typeof e=="object"&&(t=e,e=""),e&&(t.code=e);try{return Ls(r,t)}catch{t.message=r.message,t.stack=r.stack;let s=function(){};return s.prototype=Object.create(Object.getPrototypeOf(r)),Ls(new s,t)}}Ts.exports=Ca});var Ps=_((ch,Is)=>{"use strict";Is.exports=function(){return Date.now()}});var Us=_((uh,Rs)=>{"use strict";var dt=Ps(),fr=class{constructor(e,t,n){let s=this;this._started=dt(),this._rescheduled=0,this._scheduled=t,this._args=n,this._triggered=!1,this._timerWrapper=()=>{s._rescheduled>0?(s._scheduled=s._rescheduled-(dt()-s._started),s._schedule(s._scheduled)):(s._triggered=!0,e.apply(null,s._args))},this._timer=setTimeout(this._timerWrapper,t)}reschedule(e){e||(e=this._scheduled);let t=dt();t+e-(this._started+this._scheduled)<0?(clearTimeout(this._timer),this._schedule(e)):this._triggered?this._schedule(e):(this._started=t,this._rescheduled=e)}_schedule(e){this._triggered=!1,this._started=dt(),this._rescheduled=0,this._scheduled=e,this._timer=setTimeout(this._timerWrapper,e)}clear(){clearTimeout(this._timer)}};function Ua(){if(typeof arguments[0]!="function")throw new Error("callback needed");if(typeof arguments[1]!="number")throw new Error("timeout needed");let r;if(arguments.length>0){r=new Array(arguments.length-2);for(var e=0;e<r.length;e++)r[e]=arguments[e+2]}return new fr(arguments[0],arguments[1],r)}Rs.exports=Ua});var Hs=_((lh,qs)=>{"use strict";var{AbortController:za}=globalThis,zs=Us(),dr=class r extends za{constructor(e){super(),this._ms=e,this._timer=zs(()=>this.abort(),e),Object.setPrototypeOf(this,r.prototype)}abort(){return this._timer.clear(),super.abort()}clear(){this._timer.clear()}reset(){this._timer.clear(),this._timer=zs(()=>this.abort(),this._ms)}};qs.exports={TimeoutController:dr}});var yt=_((_h,wr)=>{"use strict";var Be=typeof Reflect=="object"?Reflect:null,js=Be&&typeof Be.apply=="function"?Be.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},gt;Be&&typeof Be.ownKeys=="function"?gt=Be.ownKeys:Object.getOwnPropertySymbols?gt=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:gt=function(e){return Object.getOwnPropertyNames(e)};function $a(r){console&&console.warn&&console.warn(r)}var Xs=Number.isNaN||function(e){return e!==e};function k(){k.init.call(this)}wr.exports=k;wr.exports.once=Xa;k.EventEmitter=k;k.prototype._events=void 0;k.prototype._eventsCount=0;k.prototype._maxListeners=void 0;var Qs=10;function mt(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(k,"defaultMaxListeners",{enumerable:!0,get:function(){return Qs},set:function(r){if(typeof r!="number"||r<0||Xs(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");Qs=r}});k.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};k.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||Xs(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function Js(r){return r._maxListeners===void 0?k.defaultMaxListeners:r._maxListeners}k.prototype.getMaxListeners=function(){return Js(this)};k.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var s=e==="error",i=this._events;if(i!==void 0)s=s&&i.error===void 0;else if(!s)return!1;if(s){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=i[e];if(c===void 0)return!1;if(typeof c=="function")js(c,this,t);else for(var u=c.length,l=ti(c,u),n=0;n<u;++n)js(l[n],this,t);return!0};function Ks(r,e,t,n){var s,i,o;if(mt(t),i=r._events,i===void 0?(i=r._events=Object.create(null),r._eventsCount=0):(i.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),i=r._events),o=i[e]),o===void 0)o=i[e]=t,++r._eventsCount;else if(typeof o=="function"?o=i[e]=n?[t,o]:[o,t]:n?o.unshift(t):o.push(t),s=Js(r),s>0&&o.length>s&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=r,a.type=e,a.count=o.length,$a(a)}return r}k.prototype.addListener=function(e,t){return Ks(this,e,t,!1)};k.prototype.on=k.prototype.addListener;k.prototype.prependListener=function(e,t){return Ks(this,e,t,!0)};function Ga(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Zs(r,e,t){var n={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},s=Ga.bind(n);return s.listener=t,n.wrapFn=s,s}k.prototype.once=function(e,t){return mt(t),this.on(e,Zs(this,e,t)),this};k.prototype.prependOnceListener=function(e,t){return mt(t),this.prependListener(e,Zs(this,e,t)),this};k.prototype.removeListener=function(e,t){var n,s,i,o,a;if(mt(t),s=this._events,s===void 0)return this;if(n=s[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(i=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){a=n[o].listener,i=o;break}if(i<0)return this;i===0?n.shift():ja(n,i),n.length===1&&(s[e]=n[0]),s.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};k.prototype.off=k.prototype.removeListener;k.prototype.removeAllListeners=function(e){var t,n,s;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var i=Object.keys(n),o;for(s=0;s<i.length;++s)o=i[s],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this};function Ys(r,e,t){var n=r._events;if(n===void 0)return[];var s=n[e];return s===void 0?[]:typeof s=="function"?t?[s.listener||s]:[s]:t?Qa(s):ti(s,s.length)}k.prototype.listeners=function(e){return Ys(this,e,!0)};k.prototype.rawListeners=function(e){return Ys(this,e,!1)};k.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):ei.call(r,e)};k.prototype.listenerCount=ei;function ei(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}k.prototype.eventNames=function(){return this._eventsCount>0?gt(this._events):[]};function ti(r,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=r[n];return t}function ja(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function Qa(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function Xa(r,e){return new Promise(function(t,n){function s(o){r.removeListener(e,i),n(o)}function i(){typeof r.removeListener=="function"&&r.removeListener("error",s),t([].slice.call(arguments))}ri(r,e,i,{once:!0}),e!=="error"&&Ja(r,s,{once:!0})})}function Ja(r,e,t){typeof r.on=="function"&&ri(r,"error",e,t)}function ri(r,e,t,n){if(typeof r.on=="function")n.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function s(i){n.once&&r.removeEventListener(e,s),t(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}});var pi=_((fi,di)=>{"use strict";var mc=Math.exp;fi=di.exports=function(e){if(typeof e!="number")throw new Error("must provide a timespan to the moving average constructor");if(e<=0)throw new Error("must provide a timespan > 0 to the moving average constructor");let t,n=0,s=0,i=0,o,a={};function c(u,l){return 1-mc(-(u-l)/e)}return a.push=function(l,h){if(o){let f=c(l,o),y=h-t,d=f*y;t=f*h+(1-f)*t,n=(1-f)*(n+y*d),s=Math.sqrt(n),i=t+f*y}else t=h;o=l},a.movingAverage=function(){return t},a.variance=function(){return n},a.deviation=function(){return s},a.forecast=function(){return i},a}});var xc={};P(xc,{createBitswap:()=>vc});function Dr(r){let e=new globalThis.AbortController;function t(){e.abort();for(let i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(let i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(let i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}let s=e.signal;return s.clear=n,s}function Si(r){let[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:s=>{n.push(s)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}var Ve=Si;function Ci(r){return r[Symbol.asyncIterator]!=null}function Ai(r,e){if(Ci(r))return async function*(){for await(let a of r)await e(a),yield a}();let t=Ve(r),{value:n,done:s}=t.next();if(s===!0)return function*(){}();if(typeof e(n)?.then=="function")return async function*(){yield n;for await(let a of t)await e(a),yield a}();let o=e;return function*(){yield n;for(let a of t)o(a),yield a}()}var Mr=Ai;var At={};P(At,{base32:()=>Y,base32hex:()=>Ii,base32hexpad:()=>Ri,base32hexpadupper:()=>Ui,base32hexupper:()=>Pi,base32pad:()=>Ni,base32padupper:()=>Oi,base32upper:()=>Mi,base32z:()=>zi});function Li(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function h(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var m=0,p=0,x=0,E=d.length;x!==E&&d[x]===0;)x++,m++;for(var A=(E-x)*l+1>>>0,L=new Uint8Array(A);x!==E;){for(var O=d[x],z=0,I=A-1;(O!==0||z<p)&&I!==-1;I--,z++)O+=256*L[I]>>>0,L[I]=O%a>>>0,O=O/a>>>0;if(O!==0)throw new Error("Non-zero carry");p=z,x++}for(var q=A-p;q!==A&&L[q]===0;)q++;for(var me=c.repeat(m);q<A;++q)me+=r.charAt(L[q]);return me}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var m=0;if(d[m]!==" "){for(var p=0,x=0;d[m]===c;)p++,m++;for(var E=(d.length-m)*u+1>>>0,A=new Uint8Array(E);d[m];){var L=t[d.charCodeAt(m)];if(L===255)return;for(var O=0,z=E-1;(L!==0||O<x)&&z!==-1;z--,O++)L+=a*A[z]>>>0,A[z]=L%256>>>0,L=L/256>>>0;if(L!==0)throw new Error("Non-zero carry");x=O,m++}if(d[m]!==" "){for(var I=E-x;I!==E&&A[I]===0;)I++;for(var q=new Uint8Array(p+(E-I)),me=p;I!==E;)q[me++]=A[I++];return q}}}function y(d){var m=f(d);if(m)return m;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:f,decode:y}}var Ti=Li,Bi=Ti,Nr=Bi;var Tc=new Uint8Array(0);var Or=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},J=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var Ir=r=>new TextEncoder().encode(r),Pr=r=>new TextDecoder().decode(r);var kt=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Et=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Ur(this,e)}},St=class{constructor(e){this.decoders=e}or(e){return Ur(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},Ur=(r,e)=>new St({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}}),Ct=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new kt(e,t,n),this.decoder=new Et(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},ye=({name:r,prefix:e,encode:t,decode:n})=>new Ct(r,e,t,n),Z=({prefix:r,name:e,alphabet:t})=>{let{encode:n,decode:s}=Nr(t,e);return ye({prefix:r,name:e,encode:n,decode:i=>J(s(i))})},Fi=(r,e,t,n)=>{let s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;let o=new Uint8Array(i*t/8|0),a=0,c=0,u=0;for(let l=0;l<i;++l){let h=s[r[l]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Di=(r,e,t)=>{let n=e[e.length-1]==="=",s=(1<<t)-1,i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},S=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>ye({prefix:e,name:r,encode(s){return Di(s,n,t)},decode(s){return Fi(s,n,t,r)}});var Y=S({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Mi=S({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Ni=S({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Oi=S({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Ii=S({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Pi=S({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Ri=S({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Ui=S({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),zi=S({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Lt={};P(Lt,{base58btc:()=>w,base58flickr:()=>qi});var w=Z({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),qi=Z({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Hi=Hr,zr=128,Wi=127,Vi=~Wi,$i=Math.pow(2,31);function Hr(r,e,t){e=e||[],t=t||0;for(var n=t;r>=$i;)e[t++]=r&255|zr,r/=128;for(;r&Vi;)e[t++]=r&255|zr,r>>>=7;return e[t]=r|0,Hr.bytes=t-n+1,e}var Gi=Tt,ji=128,qr=127;function Tt(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Tt.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&qr)<<s:(o&qr)*Math.pow(2,s),s+=7}while(o>=ji);return Tt.bytes=i-n,t}var Qi=Math.pow(2,7),Xi=Math.pow(2,14),Ji=Math.pow(2,21),Ki=Math.pow(2,28),Zi=Math.pow(2,35),Yi=Math.pow(2,42),eo=Math.pow(2,49),to=Math.pow(2,56),ro=Math.pow(2,63),no=function(r){return r<Qi?1:r<Xi?2:r<Ji?3:r<Ki?4:r<Zi?5:r<Yi?6:r<eo?7:r<to?8:r<ro?9:10},so={encode:Hi,decode:Gi,encodingLength:no},io=so,Fe=io;var De=(r,e=0)=>[Fe.decode(r,e),Fe.decode.bytes],we=(r,e,t=0)=>(Fe.encode(r,e,t),e),be=r=>Fe.encodingLength(r);var ie=(r,e)=>{let t=e.byteLength,n=be(r),s=n+be(t),i=new Uint8Array(s+t);return we(r,i,0),we(t,i,n),i.set(e,s),new _e(r,t,e,i)},Wr=r=>{let e=J(r),[t,n]=De(e),[s,i]=De(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new _e(t,s,o,e)},Vr=(r,e)=>{if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Or(r.bytes,t.bytes)}},_e=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};var $r=(r,e)=>{let{bytes:t,version:n}=r;switch(n){case 0:return ao(t,Bt(r),e||w.encoder);default:return co(t,Bt(r),e||Y.encoder)}};var Gr=new WeakMap,Bt=r=>{let e=Gr.get(r);if(e==null){let t=new Map;return Gr.set(r,t),t}return e},B=class r{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==Ne)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==uo)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=ie(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n&&e.code===n.code&&e.version===n.version&&Vr(e.multihash,n.multihash)}toString(e){return $r(this,e)}toJSON(){return{"/":$r(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:s,multihash:i,bytes:o}=t;return new r(n,s,i,o||jr(n,s,i.bytes))}else if(t[lo]===!0){let{version:n,multihash:s,code:i}=t,o=Wr(s);return r.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Ne)throw new Error(`Version 0 CID must use dag-pb (code: ${Ne}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let s=jr(e,t,n.bytes);return new r(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,Ne,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,s=J(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");let i=s.subarray(t.multihashSize-t.digestSize),o=new _e(t.multihashCode,t.digestSize,i,s);return[t.version===0?r.createV0(o):r.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[h,f]=De(e.subarray(t));return t+=f,h},s=n(),i=Ne;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);let o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){let[n,s]=oo(e,t),i=r.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Bt(i).set(n,e),i}},oo=(r,e)=>{switch(r[0]){case"Q":{let t=e||w;return[w.prefix,t.decode(`${w.prefix}${r}`)]}case w.prefix:{let t=e||w;return[w.prefix,t.decode(r)]}case Y.prefix:{let t=e||Y;return[Y.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},ao=(r,e,t)=>{let{prefix:n}=t;if(n!==w.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let s=e.get(n);if(s==null){let i=t.encode(r).slice(1);return e.set(n,i),i}else return s},co=(r,e,t)=>{let{prefix:n}=t,s=e.get(n);if(s==null){let i=t.encode(r);return e.set(n,i),i}else return s},Ne=112,uo=18,jr=(r,e,t)=>{let n=be(r),s=n+be(e),i=new Uint8Array(s+t.byteLength);return we(r,i,0),we(e,i,n),i.set(t,s),i},lo=Symbol.for("@ipld/js-cid/CID");var Ft=class extends Map{metric;constructor(e){super();let{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function ee(r){let{name:e,metrics:t}=r,n;return t!=null?n=new Ft({name:e,metrics:t}):n=new Map,n}var ve=class extends Error{code;props;constructor(e,t,n){super(e),this.code=t,this.name=n?.name??"CodeError",this.props=n??{}}};var Nt={};P(Nt,{sha256:()=>Oe,sha512:()=>ho});var Mt=({name:r,code:e,encode:t})=>new Dt(r,e,t),Dt=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?ie(this.code,t):t.then(n=>ie(this.code,n))}else throw Error("Unknown type, must be binary type")}};var Xr=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Oe=Mt({name:"sha2-256",code:18,encode:Xr("SHA-256")}),ho=Mt({name:"sha2-512",code:19,encode:Xr("SHA-512")});var ws=M(ln(),1);var U=M(gn(),1);var Pt={};P(Pt,{base64:()=>It,base64pad:()=>Ro,base64url:()=>Uo,base64urlpad:()=>zo});var It=S({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Ro=S({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Uo=S({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),zo=S({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});U.default.formatters.b=r=>r==null?"undefined":w.baseEncode(r);U.default.formatters.t=r=>r==null?"undefined":Y.baseEncode(r);U.default.formatters.m=r=>r==null?"undefined":It.baseEncode(r);U.default.formatters.p=r=>r==null?"undefined":r.toString();U.default.formatters.c=r=>r==null?"undefined":r.toString();U.default.formatters.k=r=>r==null?"undefined":r.toString();U.default.formatters.a=r=>r==null?"undefined":r.toString();function qo(r){let e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function mn(r){let e=qo(`${r}:trace`);return U.default.enabled(`${r}:trace`)&&U.default.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=(0,U.default)(`${r}:trace`)),Object.assign((0,U.default)(r),{error:(0,U.default)(`${r}:error`),trace:e})}function Qe(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}var ae=class{_refCounter;cid;priority;wantType;constructor(e,t,n){this._refCounter=1,this.cid=e,this.priority=t??1,this.wantType=n}inc(){this._refCounter+=1}dec(){this._refCounter=Math.max(0,this._refCounter-1)}hasRefs(){return this._refCounter>0}get[Symbol.toStringTag](){return`WantlistEntry <key: ${this.cid.toString(w)}, priority: ${this.priority}, refs: ${this._refCounter}>`}equals(e){return this._refCounter===e._refCounter&&this.cid.equals(e.cid)&&this.priority===e.priority&&this.wantType===e.wantType}};var te=class{entry;cancel;sendDontHave;constructor(e,t,n,s,i){this.entry=new ae(e,t,n),this.cancel=!!s,this.sendDontHave=!!i}get cid(){return this.entry.cid}set cid(e){this.entry.cid=e}get priority(){return this.entry.priority}set priority(e){this.entry.priority=e}get wantType(){return this.entry.wantType}set wantType(e){this.entry.wantType=e}get[Symbol.toStringTag](){return`BitswapMessageEntry ${this.cid.toString(w)} <cancel: ${this.cancel}, priority: ${this.priority}>`}equals(e){return this.cancel===e.cancel&&this.sendDontHave===e.sendDontHave&&this.wantType===e.wantType&&this.entry.equals(e.entry)}};var H=(r,e)=>{let t=["bitswap"];return e!=null&&t.push(e),r!=null&&t.push(`${r.toString().slice(0,8)}`),mn(t.join(":"))};var Xe=(r,e)=>{if(r.size!==e.size)return!1;for(let[t,n]of r){let s=e.get(t);if(s===void 0||n instanceof Uint8Array&&s instanceof Uint8Array&&!Qe(n,s)||n instanceof te&&s instanceof te&&!n.equals(s))return!1}return!0};var Ie=M(Cn(),1);function ta(r){let e=new Uint8Array(r.reduce((n,s)=>n+Ie.default.encodingLength(s),0)),t=0;for(let n of r)e=Ie.encode(n,e,t),t+=Ie.default.encodingLength(n);return e}var An=ta;var Zt=M(Vt(),1),ps=M(os(),1),gs=M(ue(),1),Yt=M(Kt(),1),ms=M(ds(),1);function la(){gs.default._configure(),Zt.default._configure(ps.default),Yt.default._configure(ms.default)}la();var ys=["uint64","int64","sint64","fixed64","sfixed64"];function ha(r){for(let e of ys){if(r[e]==null)continue;let t=r[e];r[e]=function(){return BigInt(t.call(this).toString())}}return r}function er(r){return ha(new Zt.default(r))}function fa(r){for(let e of ys){if(r[e]==null)continue;let t=r[e];r[e]=function(n){return t.call(this,n.toString())}}return r}function tr(){return fa(Yt.default.create())}function he(r,e){let t=er(r instanceof Uint8Array?r:r.subarray());return e.decode(t)}function fe(r,e){let t=tr();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var Ce;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(Ce||(Ce={}));function et(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function tt(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}let t=function(i,o){let a=e(i);o.int32(a)},n=function(i){let o=i.int32();return e(o)};return et("enum",Ce.VARINT,t,n)}function de(r,e){return et("message",Ce.LENGTH_DELIMITED,r,e)}var N;(function(r){let e;(function(a){let c;(function(f){f.Block="Block",f.Have="Have"})(c=a.WantType||(a.WantType={}));let u;(function(f){f[f.Block=0]="Block",f[f.Have=1]="Have"})(u||(u={})),function(f){f.codec=()=>tt(u)}(c=a.WantType||(a.WantType={}));let l;(function(f){let y;f.codec=()=>(y==null&&(y=de((d,m,p={})=>{p.lengthDelimited!==!1&&m.fork(),d.block!=null&&d.block.byteLength>0&&(m.uint32(10),m.bytes(d.block)),d.priority!=null&&d.priority!==0&&(m.uint32(16),m.int32(d.priority)),d.cancel!=null&&d.cancel!==!1&&(m.uint32(24),m.bool(d.cancel)),d.wantType!=null&&u[d.wantType]!==0&&(m.uint32(32),r.Wantlist.WantType.codec().encode(d.wantType,m)),d.sendDontHave!=null&&d.sendDontHave!==!1&&(m.uint32(40),m.bool(d.sendDontHave)),p.lengthDelimited!==!1&&m.ldelim()},(d,m)=>{let p={block:new Uint8Array(0),priority:0,cancel:!1,wantType:c.Block,sendDontHave:!1},x=m==null?d.len:d.pos+m;for(;d.pos<x;){let E=d.uint32();switch(E>>>3){case 1:p.block=d.bytes();break;case 2:p.priority=d.int32();break;case 3:p.cancel=d.bool();break;case 4:p.wantType=r.Wantlist.WantType.codec().decode(d);break;case 5:p.sendDontHave=d.bool();break;default:d.skipType(E&7);break}}return p})),y),f.encode=d=>fe(d,f.codec()),f.decode=d=>he(d,f.codec())})(l=a.Entry||(a.Entry={}));let h;a.codec=()=>(h==null&&(h=de((f,y,d={})=>{if(d.lengthDelimited!==!1&&y.fork(),f.entries!=null)for(let m of f.entries)y.uint32(10),r.Wantlist.Entry.codec().encode(m,y);f.full!=null&&f.full!==!1&&(y.uint32(16),y.bool(f.full)),d.lengthDelimited!==!1&&y.ldelim()},(f,y)=>{let d={entries:[],full:!1},m=y==null?f.len:f.pos+y;for(;f.pos<m;){let p=f.uint32();switch(p>>>3){case 1:d.entries.push(r.Wantlist.Entry.codec().decode(f,f.uint32()));break;case 2:d.full=f.bool();break;default:f.skipType(p&7);break}}return d})),h),a.encode=f=>fe(f,a.codec()),a.decode=f=>he(f,a.codec())})(e=r.Wantlist||(r.Wantlist={}));let t;(function(a){let c;a.codec=()=>(c==null&&(c=de((u,l,h={})=>{h.lengthDelimited!==!1&&l.fork(),u.prefix!=null&&u.prefix.byteLength>0&&(l.uint32(10),l.bytes(u.prefix)),u.data!=null&&u.data.byteLength>0&&(l.uint32(18),l.bytes(u.data)),h.lengthDelimited!==!1&&l.ldelim()},(u,l)=>{let h={prefix:new Uint8Array(0),data:new Uint8Array(0)},f=l==null?u.len:u.pos+l;for(;u.pos<f;){let y=u.uint32();switch(y>>>3){case 1:h.prefix=u.bytes();break;case 2:h.data=u.bytes();break;default:u.skipType(y&7);break}}return h})),c),a.encode=u=>fe(u,a.codec()),a.decode=u=>he(u,a.codec())})(t=r.Block||(r.Block={}));let n;(function(a){a.Have="Have",a.DontHave="DontHave"})(n=r.BlockPresenceType||(r.BlockPresenceType={}));let s;(function(a){a[a.Have=0]="Have",a[a.DontHave=1]="DontHave"})(s||(s={})),function(a){a.codec=()=>tt(s)}(n=r.BlockPresenceType||(r.BlockPresenceType={}));let i;(function(a){let c;a.codec=()=>(c==null&&(c=de((u,l,h={})=>{h.lengthDelimited!==!1&&l.fork(),u.cid!=null&&u.cid.byteLength>0&&(l.uint32(10),l.bytes(u.cid)),u.type!=null&&s[u.type]!==0&&(l.uint32(16),r.BlockPresenceType.codec().encode(u.type,l)),h.lengthDelimited!==!1&&l.ldelim()},(u,l)=>{let h={cid:new Uint8Array(0),type:n.Have},f=l==null?u.len:u.pos+l;for(;u.pos<f;){let y=u.uint32();switch(y>>>3){case 1:h.cid=u.bytes();break;case 2:h.type=r.BlockPresenceType.codec().decode(u);break;default:u.skipType(y&7);break}}return h})),c),a.encode=u=>fe(u,a.codec()),a.decode=u=>he(u,a.codec())})(i=r.BlockPresence||(r.BlockPresence={}));let o;r.codec=()=>(o==null&&(o=de((a,c,u={})=>{if(u.lengthDelimited!==!1&&c.fork(),a.wantlist!=null&&(c.uint32(10),r.Wantlist.codec().encode(a.wantlist,c)),a.blocks!=null)for(let l of a.blocks)c.uint32(18),c.bytes(l);if(a.payload!=null)for(let l of a.payload)c.uint32(26),r.Block.codec().encode(l,c);if(a.blockPresences!=null)for(let l of a.blockPresences)c.uint32(34),r.BlockPresence.codec().encode(l,c);a.pendingBytes!=null&&a.pendingBytes!==0&&(c.uint32(40),c.int32(a.pendingBytes)),u.lengthDelimited!==!1&&c.ldelim()},(a,c)=>{let u={blocks:[],payload:[],blockPresences:[],pendingBytes:0},l=c==null?a.len:a.pos+c;for(;a.pos<l;){let h=a.uint32();switch(h>>>3){case 1:u.wantlist=r.Wantlist.codec().decode(a,a.uint32());break;case 2:u.blocks.push(a.bytes());break;case 3:u.payload.push(r.Block.codec().decode(a,a.uint32()));break;case 4:u.blockPresences.push(r.BlockPresence.codec().decode(a,a.uint32()));break;case 5:u.pendingBytes=a.int32();break;default:a.skipType(h&7);break}}return u})),o),r.encode=a=>fe(a,r.codec()),r.decode=a=>he(a,r.codec())})(N||(N={}));var F=class r{static Entry=te;static WantType={Block:N.Wantlist.WantType.Block,Have:N.Wantlist.WantType.Have};static BlockPresenceType={Have:N.BlockPresenceType.Have,DontHave:N.BlockPresenceType.DontHave};static deserialize=async(e,t)=>{let n=N.decode(e),s=n.wantlist?.full===!0,i=new r(s);return n.wantlist?.entries.forEach(o=>{if(o.block==null)return;let a=B.decode(o.block);i.addEntry(a,o.priority??0,o.wantType,!!o.cancel,!!o.sendDontHave)}),n.blockPresences.forEach(o=>{if(o.cid==null)return;let a=B.decode(o.cid);o.type===r.BlockPresenceType.Have?i.addHave(a):i.addDontHave(a)}),n.blocks.length>0?(await Promise.all(n.blocks.map(async o=>{let a=await Oe.digest(o),c=B.createV0(a);i.addBlock(c,o)})),i):(n.payload.length>0&&(await Promise.all(n.payload.map(async o=>{if(o.prefix==null||o.data==null)return;let a=(0,ws.default)(o.prefix),c=a[0],u=a[1],l=a[2],h=l===Oe.code?Oe:await t?.getHasher(l);if(h==null)throw new ve("Unknown hash algorithm","ERR_UNKNOWN_HASH_ALG");let f=await h.digest(o.data),y=B.create(c,u,f);i.addBlock(y,o.data)})),i.setPendingBytes(n.pendingBytes)),i)};static blockPresenceSize=e=>e.bytes.length+1;full;wantlist;blocks;blockPresences;pendingBytes;constructor(e){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}get empty(){return this.blocks.size===0&&this.wantlist.size===0&&this.blockPresences.size===0}addEntry(e,t,n,s,i){n==null&&(n=r.WantType.Block);let o=e.toString(w),a=this.wantlist.get(o);a!=null?(a.wantType===n&&(a.priority=t),s===!0&&(a.cancel=!!s),i===!0&&(a.sendDontHave=!!i),n===r.WantType.Block&&a.wantType===r.WantType.Have&&(a.wantType=n)):this.wantlist.set(o,new te(e,t,n,s,i))}addBlock(e,t){let n=e.toString(w);this.blocks.set(n,t)}addHave(e){let t=e.toString(w);this.blockPresences.has(t)||this.blockPresences.set(t,r.BlockPresenceType.Have)}addDontHave(e){let t=e.toString(w);this.blockPresences.has(t)||this.blockPresences.set(t,r.BlockPresenceType.DontHave)}cancel(e){let t=e.toString(w);this.wantlist.delete(t),this.addEntry(e,0,r.WantType.Block,!0,!1)}setPendingBytes(e){this.pendingBytes=e}serializeToBitswap100(){return N.encode({wantlist:{entries:Array.from(this.wantlist.values()).map(e=>({block:e.cid.bytes,priority:Number(e.priority),cancel:!!e.cancel,wantType:N.Wantlist.WantType.Block,sendDontHave:!1})),full:!!this.full},blocks:Array.from(this.blocks.values())})}serializeToBitswap110(){let e={wantlist:{entries:Array.from(this.wantlist.values()).map(t=>({block:t.cid.bytes,priority:Number(t.priority),wantType:t.wantType,cancel:!!t.cancel,sendDontHave:!!t.sendDontHave})),full:!!this.full},blockPresences:[],payload:[],pendingBytes:this.pendingBytes,blocks:[]};for(let[t,n]of this.blocks.entries()){let s=B.parse(t),i=s.version,o=s.code,a=s.multihash.code,c=s.multihash.digest.length,u=An([i,o,a,c]);e.payload.push({prefix:u,data:n})}for(let[t,n]of this.blockPresences)e.blockPresences.push({cid:B.parse(t).bytes,type:n});return this.pendingBytes>0&&(e.pendingBytes=this.pendingBytes),N.encode(e)}equals(e){return!(this.full!==e.full||this.pendingBytes!==e.pendingBytes||!Xe(this.wantlist,e.wantlist)||!Xe(this.blocks,e.blocks)||!Xe(this.blockPresences,e.blockPresences))}get[Symbol.toStringTag](){let e=Array.from(this.wantlist.keys()),t=Array.from(this.blocks.keys());return`BitswapMessage <full: ${this.full}, list: ${e}, blocks: ${t}>`}};var bs={Block:N.Wantlist.WantType.Block,Have:N.Wantlist.WantType.Have},da=(r,e)=>Array.prototype.slice.call(e,0).sort((t,n)=>{let s=r(t),i=r(n);return s<i?-1:s>i?1:0}),se=class{static Entry=ae;set;_stats;constructor(e,t){this.set=t!=null?ee({name:"ipfs_bitswap_wantlist",metrics:t.metrics}):new Map,this._stats=e}get length(){return this.set.size}add(e,t,n){let s=e.toString(w),i=this.set.get(s);i!=null?(i.inc(),i.priority=t,i.wantType===bs.Have&&n===bs.Block&&(i.wantType=n)):(this.set.set(s,new ae(e,t,n)),this._stats!=null&&this._stats.push(void 0,"wantListSize",1))}remove(e){let t=e.toString(w),n=this.set.get(t);n!=null&&(n.dec(),!n.hasRefs()&&(this.set.delete(t),this._stats!=null&&this._stats.push(void 0,"wantListSize",-1)))}removeForce(e){this.set.has(e)&&this.set.delete(e)}forEach(e){this.set.forEach(e)}entries(){return this.set.entries()}sortedEntries(){return new Map(da(e=>e[1].key,Array.from(this.set.entries())))}contains(e){let t=e.toString(w);return this.set.has(t)}get(e){let t=e.toString(w);return this.set.get(t)}};var rt=class{partner;wantlist;exchangeCount;accounting;lastExchange;constructor(e){this.partner=e,this.wantlist=new se,this.exchangeCount=0,this.accounting={bytesSent:0,bytesRecv:0}}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesRecv+=e}wants(e,t,n){this.wantlist.add(e,t,n)}cancelWant(e){this.wantlist.remove(e)}wantlistContains(e){return this.wantlist.get(e)}debtRatio(){return this.accounting.bytesSent/(this.accounting.bytesRecv+1)}};var Ue=class extends Map{_cmp;_keys;constructor(e,t){super(),this._cmp=t??this._defaultSort,this._keys=[];for(let[n,s]of e??[])this.set(n,s)}update(e){if(e<0||e>=this._keys.length)return;let t=this._keys[e];this._keys.splice(e,1);let n=this._find(t);this._keys.splice(n,0,t)}set(e,t){if(this.has(e)){let s=this.indexOf(e);this._keys.splice(s,1)}super.set(e,t);let n=this._find(e);return this._keys.splice(n,0,e),this}clear(){super.clear(),this._keys=[]}delete(e){if(!this.has(e))return!1;let t=this.indexOf(e);return this._keys.splice(t,1),super.delete(e)}indexOf(e){if(!this.has(e))return-1;let t=this._find(e);if(this._keys[t]===e)return t;for(let n=1;n<this._keys.length;n++){if(this._keys[t+n]===e)return t+n;if(this._keys[t-n]===e)return t-n}return-1}_find(e){let t=0,n=this._keys.length;for(;t<n;){let s=t+n>>>1,i=this._kCmp(this._keys[s],e);if(i<0)t=s+1;else if(i>0)n=s;else return s}return t}*keys(){for(let e of this._keys)yield e}*values(){for(let e of this._keys)yield this.get(e)}*entries(){for(let e of this._keys)yield[e,this.get(e)]}*[Symbol.iterator](){yield*this.entries()}forEach(e,t=this){if(e!=null)for(let n of this._keys){let s=this.get(n);if(s==null)throw new Error("Value cannot be undefined");e.apply(t,[[n,s]])}}_defaultSort(e,t){return e[0]<t[0]?-1:t[0]<e[0]?1:0}_kCmp(e,t){return this._cmp([e,this.get(e)],[t,this.get(t)])}};var pa={hasNewInfo(){return!1},merge(){}},nt=class{_taskMerger;_byPeer;constructor(e=pa){this._taskMerger=e,this._byPeer=new Ue([],st.compare)}pushTasks(e,t){let n=this._byPeer.get(e.toString());n==null&&(n=new st(e,this._taskMerger)),n.pushTasks(t),this._byPeer.set(e.toString(),n)}popTasks(e){let t=this._head();if(t===void 0)return{tasks:[],pendingSize:0};let{tasks:n,pendingSize:s}=t.popTasks(e);if(n.length===0)return{tasks:n,pendingSize:s};let i=t.peerId;return t.isIdle()?this._byPeer.delete(i.toString()):this._byPeer.update(0),{peerId:i,tasks:n,pendingSize:s}}_head(){if(this._byPeer.size!==0)for(let[,e]of this._byPeer)return e}remove(e,t){this._byPeer.get(t.toString())?.remove(e)}tasksDone(e,t){let n=this._byPeer.get(e.toString());if(n==null)return;let s=this._byPeer.indexOf(e.toString());for(let i of t)n.taskDone(i);this._byPeer.update(s)}},st=class{peerId;_taskMerger;_activeTotalSize;_pending;_active;constructor(e,t){this.peerId=e,this._taskMerger=t,this._activeTotalSize=0,this._pending=new rr,this._active=new Set}pushTasks(e){for(let t of e)this._pushTask(t)}_pushTask(e){if(!this._taskHasMoreInfoThanActiveTasks(e))return;let t=this._pending.get(e.topic);if(t!=null){e.priority>t.priority&&this._pending.updatePriority(e.topic,e.priority),this._taskMerger.merge(e,t);return}this._pending.add(e)}_taskHasMoreInfoThanActiveTasks(e){let t=[];for(let n of this._active)n.topic===e.topic&&t.push(n);return t.length===0?!0:this._taskMerger.hasNewInfo(e,t)}popTasks(e){let t=0,n=[],s=this._pending.tasks();for(let i=0;i<s.length&&t<e;i++){let o=s[i];n.push(o),t+=o.size,this._pending.delete(o.topic),this._activeTotalSize+=o.size,this._active.add(o)}return{tasks:n,pendingSize:this._pending.totalSize}}taskDone(e){this._active.has(e)&&(this._activeTotalSize-=e.size,this._active.delete(e))}remove(e){this._pending.delete(e)}isIdle(){return this._pending.length===0&&this._active.size===0}static compare(e,t){return e[1]._pending.length===0?1:t[1]._pending.length===0?-1:e[1]._activeTotalSize===t[1]._activeTotalSize?t[1]._pending.length-e[1]._pending.length:e[1]._activeTotalSize-t[1]._activeTotalSize}},rr=class{_tasks;constructor(){this._tasks=new Ue([],this._compare)}get length(){return this._tasks.size}get totalSize(){return[...this._tasks.values()].reduce((e,t)=>e+t.task.size,0)}get(e){return this._tasks?.get(e)?.task}add(e){this._tasks.set(e.topic,{created:Date.now(),task:e})}delete(e){this._tasks.delete(e)}tasks(){return[...this._tasks.values()].map(e=>e.task)}updatePriority(e,t){let n=this._tasks.get(e);if(n==null)return;let s=this._tasks.indexOf(e);n.task.priority=t,this._tasks.update(s)}_compare(e,t){return e[1].task.priority===t[1].task.priority?e[1].created-t[1].created:t[1].task.priority-e[1].task.priority}};var _s={hasNewInfo(r,e){let t=!1,n=!1;for(let s of e)s.data.haveBlock&&(t=!0),s.data.isWantBlock&&(n=!0);return!!(!n&&r.data.isWantBlock||!t&&r.data.haveBlock)},merge(r,e){let t=r.data,n=e.data;!n.haveBlock&&t.haveBlock&&(n.haveBlock=t.haveBlock,n.blockSize=t.blockSize),!n.isWantBlock&&t.isWantBlock&&(n.isWantBlock=!0,(!n.haveBlock||t.haveBlock)&&(n.haveBlock=t.haveBlock,e.size=r.size)),n.isWantBlock&&n.haveBlock&&(e.size=n.blockSize)}};var vs=F.WantType,ga=16*1024,ma=1024,it=class{_log;blockstore;network;_stats;_opts;ledgerMap;_running;_requestQueue;constructor(e,t,n,s,i,o={}){this._log=H(e,"engine"),this.blockstore=t,this.network=n,this._stats=s,this._opts=this._processOpts(o),this.ledgerMap=ee({name:"ipfs_bitswap_ledger_map",metrics:i.metrics}),this._running=!1,this._requestQueue=new nt(_s)}_processOpts(e){return{maxSizeReplaceHasWithBlock:ma,targetMessageSize:ga,...e}}_scheduleProcessTasks(){setTimeout(()=>{this._processTasks().catch(e=>{this._log.error("error processing stats",e)})})}async _processTasks(){if(!this._running)return;let{peerId:e,tasks:t,pendingSize:n}=this._requestQueue.popTasks(this._opts.targetMessageSize);if(t.length===0)return;let s=new F(!1);s.setPendingBytes(n);let i=[],o=new Map;for(let c of t){let u=B.parse(c.topic);c.data.haveBlock?c.data.isWantBlock?(i.push(u),o.set(c.topic,c.data)):s.addHave(u):s.addDontHave(u)}let a=await this._getBlocks(i);for(let[c,u]of o){let l=B.parse(c),h=a.get(c);h!=null?s.addBlock(l,h):u.sendDontHave&&s.addDontHave(l)}if(s.empty){e!=null&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks();return}try{e!=null&&await this.network.sendMessage(e,s);for(let[c,u]of a.entries())e!=null&&this.messageSent(e,B.parse(c),u)}catch(c){this._log.error(c)}e!=null&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks()}wantlistForPeer(e){let t=e.toString(),n=this.ledgerMap.get(t);return n!=null?n.wantlist.sortedEntries():new Map}ledgerForPeer(e){let t=e.toString(),n=this.ledgerMap.get(t);if(n!=null)return{peer:n.partner,value:n.debtRatio(),sent:n.accounting.bytesSent,recv:n.accounting.bytesRecv,exchanged:n.exchangeCount}}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.partner)}receivedBlocks(e){if(e.length!==0){for(let t of this.ledgerMap.values())for(let{cid:n,block:s}of e){let i=t.wantlistContains(n);if(i==null)continue;let o=s.length,a=this._sendAsBlock(i.wantType,o),c=o;a||(c=F.blockPresenceSize(i.cid)),this._requestQueue.pushTasks(t.partner,[{topic:i.cid.toString(w),priority:i.priority,size:c,data:{blockSize:o,isWantBlock:a,haveBlock:!0,sendDontHave:!1}}])}this._scheduleProcessTasks()}}async messageReceived(e,t){let n=this._findOrCreate(e);if(t.empty)return;if(t.full&&(n.wantlist=new se),this._updateBlockAccounting(t.blocks,n),t.wantlist.size===0){this._scheduleProcessTasks();return}let s=[],i=[];t.wantlist.forEach(o=>{o.cancel?(n.cancelWant(o.cid),s.push(o.cid)):(n.wants(o.cid,o.priority,o.wantType),i.push(o))}),this._cancelWants(e,s),await this._addWants(e,i),this._scheduleProcessTasks()}_cancelWants(e,t){for(let n of t)this._requestQueue.remove(n.toString(w),e)}async _addWants(e,t){let n=await this._getBlockSizes(t.map(i=>i.cid)),s=[];for(let i of t){let o=i.cid.toString(w),a=n.get(o);if(a==null)i.sendDontHave&&s.push({topic:o,priority:i.priority,size:F.blockPresenceSize(i.cid),data:{isWantBlock:i.wantType===vs.Block,blockSize:0,haveBlock:!1,sendDontHave:i.sendDontHave}});else{let c=this._sendAsBlock(i.wantType,a),u=a;c||(u=F.blockPresenceSize(i.cid)),s.push({topic:o,priority:i.priority,size:u,data:{isWantBlock:c,blockSize:a,haveBlock:!0,sendDontHave:i.sendDontHave}})}this._requestQueue.pushTasks(e,s)}}_sendAsBlock(e,t){return e===vs.Block||t<=this._opts.maxSizeReplaceHasWithBlock}async _getBlockSizes(e){let t=await this._getBlocks(e);return new Map([...t].map(([n,s])=>[n,s.length]))}async _getBlocks(e){let t=new Map;return await Promise.all(e.map(async n=>{try{let s=await this.blockstore.get(n);t.set(n.toString(w),s)}catch(s){s.code!=="ERR_NOT_FOUND"&&this._log.error("failed to query blockstore for %s: %s",n,s)}})),t}_updateBlockAccounting(e,t){for(let n of e.values())this._log("got block (%s bytes)",n.length),t.receivedBytes(n.length)}messageSent(e,t,n){let s=this._findOrCreate(e);s.sentBytes(n.length),s.wantlist.remove(t)}numBytesSentTo(e){return this._findOrCreate(e).accounting.bytesSent}numBytesReceivedFrom(e){return this._findOrCreate(e).accounting.bytesRecv}peerDisconnected(e){this.ledgerMap.delete(e.toString())}_findOrCreate(e){let t=e.toString(),n=this.ledgerMap.get(t);if(n!=null)return n;let s=new rt(e);return this.ledgerMap.set(t,s),this._stats!=null&&this._stats.push(t,"peerCount",1),s}start(){this._running=!0}stop(){this._running=!1}};function ya(r){return r[Symbol.asyncIterator]!=null}function wa(r){if(ya(r))return(async()=>{for await(let e of r);})();for(let e of r);}var xs=wa;function ze(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}function K(r=0){return globalThis.Buffer?.alloc!=null?ze(globalThis.Buffer.alloc(r)):new Uint8Array(r)}function j(r=0){return globalThis.Buffer?.allocUnsafe!=null?ze(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}var ba=Math.pow(2,7),_a=Math.pow(2,14),va=Math.pow(2,21),nr=Math.pow(2,28),sr=Math.pow(2,35),ir=Math.pow(2,42),or=Math.pow(2,49),v=128,D=127;function pe(r){if(r<ba)return 1;if(r<_a)return 2;if(r<va)return 3;if(r<nr)return 4;if(r<sr)return 5;if(r<ir)return 6;if(r<or)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function xa(r,e,t=0){switch(pe(r)){case 8:e[t++]=r&255|v,r/=128;case 7:e[t++]=r&255|v,r/=128;case 6:e[t++]=r&255|v,r/=128;case 5:e[t++]=r&255|v,r/=128;case 4:e[t++]=r&255|v,r>>>=7;case 3:e[t++]=r&255|v,r>>>=7;case 2:e[t++]=r&255|v,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function ka(r,e,t=0){switch(pe(r)){case 8:e.set(t++,r&255|v),r/=128;case 7:e.set(t++,r&255|v),r/=128;case 6:e.set(t++,r&255|v),r/=128;case 5:e.set(t++,r&255|v),r/=128;case 4:e.set(t++,r&255|v),r>>>=7;case 3:e.set(t++,r&255|v),r>>>=7;case 2:e.set(t++,r&255|v),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function Ea(r,e){let t=r[e],n=0;if(n+=t&D,t<v||(t=r[e+1],n+=(t&D)<<7,t<v)||(t=r[e+2],n+=(t&D)<<14,t<v)||(t=r[e+3],n+=(t&D)<<21,t<v)||(t=r[e+4],n+=(t&D)*nr,t<v)||(t=r[e+5],n+=(t&D)*sr,t<v)||(t=r[e+6],n+=(t&D)*ir,t<v)||(t=r[e+7],n+=(t&D)*or,t<v))return n;throw new RangeError("Could not decode varint")}function Sa(r,e){let t=r.get(e),n=0;if(n+=t&D,t<v||(t=r.get(e+1),n+=(t&D)<<7,t<v)||(t=r.get(e+2),n+=(t&D)<<14,t<v)||(t=r.get(e+3),n+=(t&D)<<21,t<v)||(t=r.get(e+4),n+=(t&D)*nr,t<v)||(t=r.get(e+5),n+=(t&D)*sr,t<v)||(t=r.get(e+6),n+=(t&D)*ir,t<v)||(t=r.get(e+7),n+=(t&D)*or,t<v))return n;throw new RangeError("Could not decode varint")}function ks(r,e,t=0){return e==null&&(e=j(pe(r))),e instanceof Uint8Array?xa(r,e,t):ka(r,e,t)}function Es(r,e=0){return r instanceof Uint8Array?Ea(r,e):Sa(r,e)}function ar(r,e){e==null&&(e=r.reduce((s,i)=>s+i.length,0));let t=j(e),n=0;for(let s of r)t.set(s,n),n+=s.length;return ze(t)}var As=Symbol.for("@achingbrain/uint8arraylist");function Cs(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(let n of r){let s=t+n.byteLength;if(e<s)return{buf:n,index:e-t};t=s}throw new RangeError("index is out of bounds")}function ot(r){return!!r?.[As]}var Ae=class r{constructor(...e){Object.defineProperty(this,As,{value:!0}),this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(ot(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(ot(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){let t=Cs(this.bufs,e);return t.buf[t.index]}set(e,t){let n=Cs(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(ot(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){let{bufs:n,length:s}=this._subList(e,t);return ar(n,s)}subarray(e,t){let{bufs:n,length:s}=this._subList(e,t);return n.length===1?n[0]:ar(n,s)}sublist(e,t){let{bufs:n,length:s}=this._subList(e,t),i=new r;return i.length=s,i.bufs=n,i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:[...this.bufs],length:this.length};let n=[],s=0;for(let i=0;i<this.bufs.length;i++){let o=this.bufs[i],a=s,c=a+o.byteLength;if(s=c,e>=c)continue;let u=e>=a&&e<c,l=t>a&&t<=c;if(u&&l){if(e===a&&t===c){n.push(o);break}let h=e-a;n.push(o.subarray(h,h+(t-e)));break}if(u){if(e===0){n.push(o);continue}n.push(o.subarray(e-a));continue}if(l){if(t===c){n.push(o);break}n.push(o.subarray(0,t-a));break}n.push(o)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!ot(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;let s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");let i=256,o=new Int32Array(i);for(let h=0;h<i;h++)o[h]=-1;for(let h=0;h<s;h++)o[n[h]]=h;let a=o,c=this.byteLength-n.byteLength,u=n.byteLength-1,l;for(let h=t;h<=c;h+=l){l=0;for(let f=u;f>=0;f--){let y=this.get(h+f);if(n[f]!==y){l=Math.max(1,f-a[y]);break}}if(l===0)return h}return-1}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let n=j(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){let s=K(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,n),this.write(s,e)}getInt32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){let s=K(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,n),this.write(s,e)}getBigInt64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){let s=K(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,n),this.write(s,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let n=j(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){let s=K(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,n),this.write(s,e)}getUint32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){let s=K(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,n),this.write(s,e)}getBigUint64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){let s=K(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,n),this.write(s,e)}getFloat32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){let s=K(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,n),this.write(s,e)}getFloat64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){let s=K(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,n),this.write(s,e)}equals(e){if(e==null||!(e instanceof r)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!Qe(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){let n=new r;return n.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),n.length=t,n}};function at(r){return r[Symbol.asyncIterator]!=null}var ct=r=>{let e=pe(r),t=j(e);return ks(r,t),ct.bytes=e,t};ct.bytes=0;function ut(r,e){e=e??{};let t=e.lengthEncoder??ct;function*n(s){let i=t(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}return at(r)?async function*(){for await(let s of r)yield*n(s)}():function*(){for(let s of r)yield*n(s)}()}ut.single=(r,e)=>{e=e??{};let t=e.lengthEncoder??ct;return new Ae(t(r.byteLength),r)};var Le=M(Bs(),1);var Aa=8,La=1024*1024*4,ge;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(ge||(ge={}));var cr=r=>{let e=Es(r);return cr.bytes=pe(e),e};cr.bytes=0;function qe(r,e){let t=new Ae,n=ge.LENGTH,s=-1,i=e?.lengthDecoder??cr,o=e?.maxLengthLength??Aa,a=e?.maxDataLength??La;function*c(){for(;t.byteLength>0;){if(n===ge.LENGTH)try{if(s=i(t),s<0)throw(0,Le.default)(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(s>a)throw(0,Le.default)(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");let u=i.bytes;t.consume(u),e?.onLength!=null&&e.onLength(s),n=ge.DATA}catch(u){if(u instanceof RangeError){if(t.byteLength>o)throw(0,Le.default)(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw u}if(n===ge.DATA){if(t.byteLength<s)break;let u=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(u),yield u,n=ge.LENGTH}}}return at(r)?async function*(){for await(let u of r)t.append(u),yield*c();if(t.byteLength>0)throw(0,Le.default)(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(let u of r)t.append(u),yield*c();if(t.byteLength>0)throw(0,Le.default)(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}qe.fromReader=(r,e)=>{let t=1,n=async function*(){for(;;)try{let{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return qe(n,{...e??{},onLength:i=>{t=i}})};function Ba(r){return r[Symbol.asyncIterator]!=null}function Fa(r,e){if(Ba(r))return async function*(){for await(let a of r)yield e(a)}();let t=Ve(r),{value:n,done:s}=t.next();if(s===!0)return function*(){}();let i=e(n);if(typeof i.then=="function")return async function*(){yield await i;for await(let a of t)yield e(a)}();let o=e;return function*(){yield i;for(let a of t)yield o(a)}()}var Fs=Fa;function lt(){let r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}var ht=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},Te=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new ht(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new ht(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var ur=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function ft(r={}){return Da(t=>{let n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function Da(r,e){e=e??{};let t=e.onEnd,n=new Te,s,i,o,a=lt(),c=async()=>{try{return n.isEmpty()?o?{done:!0}:await new Promise((p,x)=>{i=E=>{i=null,n.push(E);try{p(r(n))}catch(A){x(A)}return s}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=lt()})}},u=p=>i!=null?i(p):(n.push(p),s),l=p=>(n=new Te,i!=null?i({error:p}):(n.push({error:p}),s)),h=p=>{if(o)return s;if(e?.objectMode!==!0&&p?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return u({done:!1,value:p})},f=p=>o?s:(o=!0,p!=null?l(p):u({done:!0})),y=()=>(n=new Te,f(),{done:!0}),d=p=>(f(p),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:y,throw:d,push:h,end:f,get readableLength(){return n.size},onEmpty:async p=>{let x=p?.signal;if(x?.throwIfAborted(),n.isEmpty())return;let E,A;x!=null&&(E=new Promise((L,O)=>{A=()=>{O(new ur)},x.addEventListener("abort",A)}));try{await Promise.race([a.promise,E])}finally{A!=null&&x!=null&&x?.removeEventListener("abort",A)}}},t==null)return s;let m=s;return s={[Symbol.asyncIterator](){return this},next(){return m.next()},throw(p){return m.throw(p),t!=null&&(t(p),t=void 0),{done:!0}},return(){return m.return(),t!=null&&(t(),t=void 0),{done:!0}},push:h,end(p){return m.end(p),t!=null&&(t(p),t=void 0),s},get readableLength(){return m.readableLength}},s}function Ma(r){return r[Symbol.asyncIterator]!=null}function Na(...r){let e=[];for(let t of r)Ma(t)||e.push(t);return e.length===r.length?function*(){for(let t of e)yield*t}():async function*(){let t=ft({objectMode:!0});Promise.resolve().then(async()=>{try{await Promise.all(r.map(async n=>{for await(let s of n)t.push(s)})),t.end()}catch(n){t.end(n)}}),yield*t}()}var Ds=Na;function hr(r,...e){if(r==null)throw new Error("Empty pipeline");if(lr(r)){let n=r;r=()=>n.source}else if(Ns(r)||Ms(r)){let n=r;r=()=>n}let t=[r,...e];if(t.length>1&&lr(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)lr(t[n])&&(t[n]=Ia(t[n]));return Oa(...t)}var Oa=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},Ms=r=>r?.[Symbol.asyncIterator]!=null,Ns=r=>r?.[Symbol.iterator]!=null,lr=r=>r==null?!1:r.sink!=null&&r.source!=null,Ia=r=>e=>{let t=r.sink(e);if(t?.then!=null){let n=ft({objectMode:!0});t.then(()=>{n.end()},o=>{n.end(o)});let s,i=r.source;if(Ms(i))s=async function*(){yield*i,n.end()};else if(Ns(i))s=function*(){yield*i,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Ds(n,s())}return r.source};function Pa(r){return r[Symbol.asyncIterator]!=null}function Ra(r,e){return Pa(r)?async function*(){let t=0;if(!(e<1)){for await(let n of r)if(yield n,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(let n of r)if(yield n,t++,t===e)return}}()}var Os=Ra;var Q=class extends Event{constructor(e,t){super(e),this.detail=t}};var Gs=M(Hs(),1);var Ws=Math.pow(2,31)-1,Vs=1e3,$s=1;var gr="/ipfs/bitswap/1.0.0",mr="/ipfs/bitswap/1.1.0",yr="/ipfs/bitswap/1.2.0",Ha=1024,Wa=1024,Va=3e4,pt=class{_log;_libp2p;_bitswap;_protocols;_stats;_running;_hashLoader;_maxInboundStreams;_maxOutboundStreams;_incomingStreamTimeout;_registrarIds;constructor(e,t,n,s={}){this._log=H(e.peerId,"network"),this._libp2p=e,this._bitswap=t,this._protocols=[gr],s.b100Only!==!0&&(this._protocols.unshift(mr),this._protocols.unshift(yr)),this._stats=n,this._running=!1,this._onPeerConnect=this._onPeerConnect.bind(this),this._onPeerDisconnect=this._onPeerDisconnect.bind(this),this._onConnection=this._onConnection.bind(this),this._hashLoader=s.hashLoader??{async getHasher(){throw new Error("Not implemented")}},this._maxInboundStreams=s.maxInboundStreams??Ha,this._maxOutboundStreams=s.maxOutboundStreams??Wa,this._incomingStreamTimeout=s.incomingStreamTimeout??Va}async start(){this._running=!0,await this._libp2p.handle(this._protocols,this._onConnection,{maxInboundStreams:this._maxInboundStreams,maxOutboundStreams:this._maxOutboundStreams});let e={onConnect:this._onPeerConnect,onDisconnect:this._onPeerDisconnect};this._registrarIds=[];for(let t of this._protocols)this._registrarIds.push(await this._libp2p.register(t,e));this._libp2p.getConnections().forEach(t=>{this._onPeerConnect(t.remotePeer)})}async stop(){if(this._running=!1,await this._libp2p.unhandle(this._protocols),this._registrarIds!=null){for(let e of this._registrarIds)this._libp2p.unregister(e);this._registrarIds=[]}}_onConnection(e){if(!this._running)return;let{stream:t,connection:n}=e,s=new Gs.TimeoutController(this._incomingStreamTimeout);Promise.resolve().then(async()=>{this._log("incoming new bitswap %s connection from %p",t.protocol,n.remotePeer);let i=()=>{t.abort(new ve("Incoming Bitswap stream timed out","ERR_TIMEOUT"))},o=AbortSignal.timeout(this._incomingStreamTimeout);o.addEventListener("abort",i),await hr(t,a=>qe(a),async a=>{for await(let c of a){try{let u=await F.deserialize(c.subarray(),this._hashLoader);await this._bitswap._receiveMessage(n.remotePeer,u)}catch(u){this._bitswap._receiveError(u);break}o.removeEventListener("abort",i),o=AbortSignal.timeout(this._incomingStreamTimeout),o.addEventListener("abort",i)}}),await t.close({signal:o})}).catch(i=>{this._log(i),t.abort(i)}).finally(()=>{s.clear()})}_onPeerConnect(e){this._bitswap._onPeerConnected(e)}_onPeerDisconnect(e){this._bitswap._onPeerDisconnected(e)}findProviders(e,t={}){return t.onProgress?.(new Q("bitswap:network:find-providers",e)),this._libp2p.contentRouting.findProviders(e,t)}async findAndConnect(e,t){await xs(Os(Fs(this.findProviders(e,t),async n=>this.connectTo(n.id,t).catch(s=>{this._log.error(s)})),3)).catch(n=>{this._log.error(n)})}async provide(e,t={}){t.onProgress?.(new Q("bitswap:network:provide",e)),await this._libp2p.contentRouting.provide(e,t)}async sendMessage(e,t,n={}){if(!this._running)throw new Error("network isn't running");let s=e.toString();this._log("sendMessage to %s",s,t),n.onProgress?.(new Q("bitswap:network:send-wantlist",e)),await this._writeMessage(e,t,n),this._updateSentStats(e,t.blocks)}async connectTo(e,t={}){if(!this._running)throw new Error("network isn't running");return t.onProgress?.(new Q("bitswap:network:dial",e)),this._libp2p.dial(e,t)}_updateSentStats(e,t){let n=e.toString();if(this._stats!=null){for(let s of t.values())this._stats.push(n,"dataSent",s.length);this._stats.push(n,"blocksSent",t.size)}}async _writeMessage(e,t,n={}){let s=await this._libp2p.dialProtocol(e,[yr,mr,gr]);try{let i;switch(s.protocol){case gr:i=t.serializeToBitswap100();break;case mr:case yr:i=t.serializeToBitswap110();break;default:throw new Error(`Unknown protocol: ${s.protocol}`)}await hr([i],o=>ut(o),s),await s.close()}catch(i){n.onProgress?.(new Q("bitswap:network:send-wantlist:error",{peer:e,error:i})),this._log(i),s.abort(i)}}};var hi=M(yt(),1);var br={};P(br,{base10:()=>Ka});var Ka=Z({prefix:"9",name:"base10",alphabet:"0123456789"});var _r={};P(_r,{base16:()=>Za,base16upper:()=>Ya});var Za=S({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Ya=S({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var vr={};P(vr,{base2:()=>ec});var ec=S({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var xr={};P(xr,{base256emoji:()=>ic});var ni=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),tc=ni.reduce((r,e,t)=>(r[t]=e,r),[]),rc=ni.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function nc(r){return r.reduce((e,t)=>(e+=tc[t],e),"")}function sc(r){let e=[];for(let t of r){let n=rc[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}var ic=ye({prefix:"\u{1F680}",name:"base256emoji",encode:nc,decode:sc});var kr={};P(kr,{base36:()=>oc,base36upper:()=>ac});var oc=Z({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),ac=Z({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var Er={};P(Er,{base8:()=>cc});var cc=S({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var Sr={};P(Sr,{identity:()=>uc});var uc=ye({prefix:"\0",name:"identity",encode:r=>Pr(r),decode:r=>Ir(r)});var Th=new TextEncoder,Bh=new TextDecoder;var Cr={};P(Cr,{identity:()=>pc});var si=0,fc="identity",ii=J,dc=r=>ie(si,ii(r)),pc={code:si,name:fc,encode:ii,digest:dc};var Ar={...Sr,...vr,...Er,...br,..._r,...At,...kr,...Lt,...Pt,...xr},Ph={...Nt,...Cr};function ai(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var oi=ai("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),Lr=ai("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=j(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),gc={utf8:oi,"utf-8":oi,hex:Ar.base16,latin1:Lr,ascii:Lr,binary:Lr,...Ar},ci=gc;function Tr(r,e="utf8"){let t=ci[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):t.encoder.encode(r).substring(1)}var ui=r=>`unwant:${Tr(r.multihash.bytes,"base64")}`,li=r=>`block:${Tr(r.multihash.bytes,"base64")}`,wt=class extends hi.EventEmitter{_log;constructor(e){super(),this.setMaxListeners(Vs),this._log=H(e,"notif")}hasBlock(e,t){let n=li(e);this._log(n),this.emit(n,t)}async wantBlock(e,t={}){if(e==null)throw new Error("Not a valid cid");let n=li(e),s=ui(e);return this._log(`wantBlock:${e}`),new Promise((i,o)=>{let a=()=>{this.removeListener(n,c),t.onProgress?.(new Q("bitswap:want-block:unwant",e)),o(new Error(`Block for ${e} unwanted`))},c=u=>{this.removeListener(s,a),t.onProgress?.(new Q("bitswap:want-block:block",e)),i(u)};this.once(s,a),this.once(n,c),t.signal?.addEventListener("abort",()=>{this.removeListener(n,c),this.removeListener(s,a),o(new Error(`Want for ${e} aborted`))})})}unwantBlock(e){let t=ui(e);this._log(t),this.emit(t)}};var yi=M(yt(),1);var gi=M(yt(),1),Br=M(pi(),1),He=class extends gi.EventEmitter{_options;_queue;_stats;_frequencyLastTime;_frequencyAccumulators;_movingAverages;_enabled;_timeout;constructor(e,t){super(),this._options=t,this._queue=[],this._stats={},this._frequencyLastTime=Date.now(),this._frequencyAccumulators={},this._movingAverages={},this._update=this._update.bind(this),e.forEach(n=>{this._stats[n]=BigInt(0),this._movingAverages[n]={},this._options.movingAverageIntervals.forEach(s=>{(this._movingAverages[n][s]=(0,Br.default)(s)).push(this._frequencyLastTime,0)})}),this._enabled=this._options.enabled}enable(){this._enabled=!0}disable(){this._enabled=!1}stop(){this._timeout!=null&&clearTimeout(this._timeout)}get snapshot(){return Object.assign({},this._stats)}get movingAverages(){return Object.assign({},this._movingAverages)}push(e,t){this._enabled&&(this._queue.push([e,t,Date.now()]),this._resetComputeTimeout())}_resetComputeTimeout(){this._timeout!=null&&clearTimeout(this._timeout),this._timeout=setTimeout(this._update,this._nextTimeout())}_nextTimeout(){let e=this._queue.length/this._options.computeThrottleMaxQueueSize;return Math.max(this._options.computeThrottleTimeout*(1-e),0)}_update(){if(this._timeout=void 0,this._queue.length>0){let e;for(;this._queue.length>0;){let t=e=this._queue.shift();t!=null&&this._applyOp(t)}e!=null&&this._updateFrequency(e[2]),this.emit("update",this._stats)}}_updateFrequency(e){let t=e-this._frequencyLastTime;t>0&&Object.keys(this._stats).forEach(n=>{this._updateFrequencyFor(n,t,e)}),this._frequencyLastTime=e}_updateFrequencyFor(e,t,n){let s=this._frequencyAccumulators[e]??0;this._frequencyAccumulators[e]=0;let i=s/t*1e3,o=this._movingAverages[e];o==null&&(o=this._movingAverages[e]={}),this._options.movingAverageIntervals.forEach(a=>{let c=o[a];c==null&&(c=o[a]=(0,Br.default)(a)),c.push(n,i)})}_applyOp(e){let t=e[0],n=e[1];if(typeof n!="number")throw new Error(`invalid increment number: ${n}`);Object.prototype.hasOwnProperty.call(this._stats,t)||(this._stats[t]=BigInt(0)),this._stats[t]=BigInt(this._stats[t])+BigInt(n),this._frequencyAccumulators[t]==null&&(this._frequencyAccumulators[t]=0),this._frequencyAccumulators[t]+=n}};var mi={enabled:!1,computeThrottleTimeout:1e3,computeThrottleMaxQueueSize:1e3,movingAverageIntervals:[60*1e3,5*60*1e3,15*60*1e3]},bt=class extends yi.EventEmitter{_initialCounters;_options;_enabled;_global;_peers;constructor(e,t=[],n=mi){super();let s=Object.assign({},mi,n);if(typeof s.computeThrottleTimeout!="number")throw new Error("need computeThrottleTimeout");if(typeof s.computeThrottleMaxQueueSize!="number")throw new Error("need computeThrottleMaxQueueSize");this._initialCounters=t,this._options=s,this._enabled=this._options.enabled,this._global=new He(t,s),this._global.on("update",i=>this.emit("update",i)),this._peers=ee({name:"ipfs_bitswap_stats_peers",metrics:e.metrics})}enable(){this._enabled=!0,this._options.enabled=!0,this._global.enable()}disable(){this._enabled=!1,this._options.enabled=!1,this._global.disable()}stop(){this._enabled=!1,this._global.stop();for(let e of this._peers)e[1].stop()}get snapshot(){return this._global.snapshot}get movingAverages(){return this._global.movingAverages}forPeer(e){let t=e.toString();return this._peers.get(t)}push(e,t,n){if(this._enabled&&(this._global.push(t,n),e!=null)){let s=this._peers.get(e);s==null&&(s=new He(this._initialCounters,this._options),this._peers.set(e,s)),s.push(t,n)}}disconnected(e){let t=e.toString(),n=this._peers.get(t);n!=null&&(n.stop(),this._peers.delete(t))}};var wi=yc;function yc(r,e,t){var n=null,s=null,i=function(){n&&(clearTimeout(n),s=null,n=null)},o=function(){var c=s;i(),c&&c()},a=function(){if(!e)return r.apply(this,arguments);var c=this,u=arguments,l=t&&!n;if(i(),s=function(){r.apply(c,u)},n=setTimeout(function(){if(n=null,!l){var h=s;return s=null,h()}},e),l)return s()};return a.cancel=i,a.flush=o,a}var _t=class{peerId;refcnt;network;_entries;_log;constructor(e,t,n){this.peerId=t,this.network=n,this.refcnt=1,this._entries=[],this._log=H(e,"msgqueue"),this.sendEntries=wi(this.sendEntries.bind(this),$s)}addMessage(e,t={}){e.empty||this.send(e,t)}addEntries(e,t={}){this._entries=this._entries.concat(e),this.sendEntries(t)}sendEntries(e={}){if(this._entries.length===0)return;let t=new F(!1);this._entries.forEach(n=>{n.cancel===!0?t.cancel(n.cid):t.addEntry(n.cid,n.priority)}),this._entries=[],this.addMessage(t,e)}async send(e,t={}){try{await this.network.connectTo(this.peerId,t)}catch(n){this._log.error("cant connect to peer %p: %s",this.peerId,n.message);return}this._log("sending message to peer %p",this.peerId),this.network.sendMessage(this.peerId,e,t).catch(n=>{this._log.error("send error",n)})}};var vt=class{peers;wantlist;network;_peerId;_log;constructor(e,t,n,s){this.peers=ee({name:"ipfs_bitswap_want_manager_peers",metrics:s.metrics}),this.wantlist=new se(n,s),this.network=t,this._peerId=e,this._log=H(e,"want")}_addEntries(e,t,n,s={}){let i=e.map((o,a)=>new F.Entry(o,Ws-a,F.WantType.Block,t));i.forEach(o=>{o.cancel?n===!0?this.wantlist.removeForce(o.cid.toString(w)):this.wantlist.remove(o.cid):(this._log("adding to wantlist"),this.wantlist.add(o.cid,o.priority))});for(let o of this.peers.values())o.addEntries(i,s)}_startPeerHandler(e){let t=this.peers.get(e.toString());if(t!=null){t.refcnt++;return}t=new _t(this._peerId,e,this.network);let n=new F(!0);for(let s of this.wantlist.entries())n.addEntry(s[1].cid,s[1].priority);return t.addMessage(n),this.peers.set(e.toString(),t),t}_stopPeerHandler(e){let t=this.peers.get(e.toString());t!=null&&(t.refcnt--,!(t.refcnt>0)&&this.peers.delete(e.toString()))}wantBlocks(e,t={}){this._addEntries(e,!1,!1,t),t.signal?.addEventListener("abort",()=>{this.cancelWants(e)})}unwantBlocks(e){this._log("unwant blocks: %s",e.length),this._addEntries(e,!0,!0)}cancelWants(e){this._log("cancel wants: %s",e.length),this._addEntries(e,!0)}connectedPeers(){return Array.from(this.peers.keys())}connected(e){this._startPeerHandler(e)}disconnected(e){this._stopPeerHandler(e)}start(){}stop(){this.peers.forEach(e=>{this.disconnected(e.peerId)})}};var wc={async getHasher(){throw new Error("Not implemented")}},bc={maxInboundStreams:1024,maxOutboundStreams:1024,incomingStreamTimeout:3e4,hashLoader:wc,statsEnabled:!1,statsComputeThrottleTimeout:1e3,statsComputeThrottleMaxQueueSize:1e3},_c=["blocksReceived","dataReceived","dupBlksReceived","dupDataReceived","blocksSent","dataSent","providesBufferLength","wantListLength","peerCount"],xt=class{_libp2p;_log;stats;network;blockstore;engine;wm;notifications;started;constructor(e,t,n={}){this._libp2p=e,this._log=H(this.peerId),n=Object.assign({},bc,n),this.stats=new bt(e,_c,{enabled:n.statsEnabled,computeThrottleTimeout:n.statsComputeThrottleTimeout,computeThrottleMaxQueueSize:n.statsComputeThrottleMaxQueueSize}),this.network=new pt(e,this,this.stats,{hashLoader:n.hashLoader,maxInboundStreams:n.maxInboundStreams,maxOutboundStreams:n.maxOutboundStreams,incomingStreamTimeout:n.incomingStreamTimeout}),this.blockstore=t,this.engine=new it(this.peerId,t,this.network,this.stats,e),this.wm=new vt(this.peerId,this.network,this.stats,e),this.notifications=new wt(this.peerId),this.started=!1}isStarted(){return this.started}get peerId(){return this._libp2p.peerId}async _receiveMessage(e,t){try{await this.engine.messageReceived(e,t)}catch{this._log("failed to receive message",t)}if(t.blocks.size===0)return;let n=[];for(let[s,i]of t.blocks.entries()){let o=B.parse(s);n.push({wasWanted:this.wm.wantlist.contains(o),cid:o,data:i})}this.wm.cancelWants(n.filter(({wasWanted:s})=>s).map(({cid:s})=>s)),await Promise.all(n.map(async({cid:s,wasWanted:i,data:o})=>{await this._handleReceivedBlock(e,s,o,i)}))}async _handleReceivedBlock(e,t,n,s){this._log("received block");let i=await this.blockstore.has(t);this._updateReceiveCounters(e.toString(),t,n,i),s&&await this.put(t,n)}_updateReceiveCounters(e,t,n,s){this.stats.push(e,"blocksReceived",1),this.stats.push(e,"dataReceived",n.length),s&&(this.stats.push(e,"dupBlksReceived",1),this.stats.push(e,"dupDataReceived",n.length))}_receiveError(e){this._log.error("ReceiveError",e)}_onPeerConnected(e){this.wm.connected(e)}_onPeerDisconnected(e){this.wm.disconnected(e),this.engine.peerDisconnected(e),this.stats.disconnected(e)}enableStats(){this.stats.enable()}disableStats(){this.stats.disable()}wantlistForPeer(e,t){return this.engine.wantlistForPeer(e)}ledgerForPeer(e){return this.engine.ledgerForPeer(e)}async want(e,t={}){let n=async(c,u)=>(this.wm.wantBlocks([c],u),this.notifications.wantBlock(c,u)),s=!1,i=async(c,u)=>{try{return await this.blockstore.get(c,u)}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l;return s||(s=!0,this.network.findAndConnect(c,u).catch(h=>{this._log.error(h)})),await n(c,u)}},o=new AbortController,a=Dr([o.signal,t.signal]);try{return await Promise.race([this.notifications.wantBlock(e,{...t,signal:a}),i(e,{...t,signal:a})])}finally{o.abort(),a.clear()}}unwant(e){let t=Array.isArray(e)?e:[e];this.wm.unwantBlocks(t),t.forEach(n=>{this.notifications.unwantBlock(n)})}cancelWants(e){this.wm.cancelWants(Array.isArray(e)?e:[e])}async put(e,t,n){await this.blockstore.put(e,t),this.notify(e,t)}async*putMany(e,t){yield*this.blockstore.putMany(Mr(e,({cid:n,block:s})=>{this.notify(n,s)}),t)}notify(e,t,n={}){this.notifications.hasBlock(e,t),this.engine.receivedBlocks([{cid:e,block:t}]),this.network.provide(e,n).catch(s=>{this._log.error("Failed to provide: %s",s.message)})}getWantlist(){return this.wm.wantlist.entries()}get peers(){return this.engine.peers()}async start(){this.wm.start(),await this.network.start(),this.engine.start(),this.started=!0}async stop(){this.stats.stop(),this.wm.stop(),await this.network.stop(),this.engine.stop(),this.started=!1}};var vc=(r,e,t={})=>new xt(r,e,t);return Ei(xc);})();
return IpfsBitswap}));
